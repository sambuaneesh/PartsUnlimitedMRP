



================================================
FILE: Labfiles/DevOps200.1x-PracticesandPrinciples/Mod03/python-ci-example-master/README.md
================================================
---
layout: page
title:  DevOps200.1x Primciples and Practices - M01 Azure Automation Labs
category: IaC
order: 1
---


<h3><span style="color: #0000CD;"> Introduction</span></h3> 



Continuous integration (CI) is one of the Agile and DevOps software development practices. It helps development teams avoid  merge conflicts by setting up a continuous merging of new code updates into a shared central repository.

Automating the build and testing of code each time one of your team members commit a change to your version control is one of the best practices in DevOps. This practice adds the "fail-fast" paradigm for your application development and an iterative development approach.

Continuous integration is about delivering small chunk of code continuously which improves a development team productivity and helps them fix bugs quickly before the release and deployment phases.


There are several CI tools like Jenkins, Buildbot, TravisCI, GoCD and Team Foundation Server.

<h3><span style="color: #0000CD;">  Preparing Our Application</span></h3> 

In this practice lab, we are going to work on a Python project. The purpose of this lab is creating a system that trigger a list of tasks once a developer push a code to a share code repository. 

We are going to use:

- Python 3.5
- Python Virtualenv to create an isolated environment for our application
- Unittest: A unit testing framework for Python
- Github: A web-based Git version control repository hosting service
- CircleCI: A hosted continuous integration testing tool integrated with code management services such as GitHub

This is the structure of our code:

```

app/
├── __init__.py
├── src
│   ├── app.py
│   ├── __init__.py
└── tests
    ├── app-test.py
    └── __init__.py
.gitignore
.travisci
__init__.py
README.md    
```

Where app.py is the source of our application, app-test.py is the test case and all of the \__init\__.py files are empty.

You can also download the .gitignore file from [this repository](https://github.com/github/gitignore/blob/master/Python.gitignore).

You can use Python Virtualenv and create an isolated environment. You can download virtualenv source from [here](https://pypi.python.org/pypi/virtualenv) and execute the setup.py script to install it. To activate your virtual environment execute:


```
python3 -m venv /path/to/new/virtual/environment
```

If you are using Linux.

```
c:\>c:\Python35\python -m venv c:\path\to\myenv
```

If you are using Windows.

If everything is fine, let's activate it:

```
. /path/to/new/virtual/environment/bin/activate
```

Our app.py is a simple application that returns the sum of two numbers:

```
def my_function(param1, param2):
    return param1 + param2   
```

<h3><span style="color: #0000CD;">  Unit Testing</span></h3> 

In order to test our application, we are going to write our a test scenario using Python unittest (tests/app-test.py):

```
import unittest
from app.src.app import my_function


class MyTest(unittest.TestCase):
    def test_my_function(self):
        self.assertEqual(my_function(1, 1), 2)
        self.assertEqual(my_function(1, -1), 0)
        self.assertEqual(my_function(0, 0), 0)
        self.assertEqual(my_function(-1, -1), -2)
        self.assertEqual(my_function(1.0, 1), 2)        
        self.assertEqual(my_function(1.1, 1.1), 2.2)        
        
        
        
if __name__ == '__main__':
    unittest.main()        
```

In the previous test code, we tested different scenarios like summing up two negative integers or two floats. It is a good practice to think about the best possible scenarios and implement the suitable test cases in order to reduce the number of bugs.

You can execute this test case using the following command:

```
python app/tests/app-test.py 
```

If tests run without any problem you should see:

```
.
----------------------------------------------------------------------
Ran 1 test in 0.000s

OK
```

If you have one or more problems with your test assertions, the test will not pass.

For example:

```
import unittest
from app.src.app import my_function


class MyTest(unittest.TestCase):
    def test_my_function(self):
        # 1 + 1 = 4
        self.assertEqual(my_function(1, 1), 4)
        
        
        
if __name__ == '__main__':
    unittest.main()        
```

The output of the test execution will be similar to the following:

```
F
======================================================================
FAIL: test_my_function (__main__.MyTest)
----------------------------------------------------------------------
Traceback (most recent call last):
  File "app/tests/app-test.py", line 7, in test_my_function
    self.assertEqual(my_function(1, 1), 4)
AssertionError: 2 != 4

----------------------------------------------------------------------
Ran 1 test in 0.001s

FAILED (failures=1)
```

<h3><span style="color: #0000CD;">Dependencies</span></h3> 

When you use a programming language to develop your application, you usually need to install libraries. This is the case for Python and that's why we need to declare our dependencies. This is done in the requirements.txt file using this command:

```
pip freeze > requirements.txt
```

In this project, we are not using any additional library, that's why our requirements.txt will be empty but always remember this step.

In order to integrate the Travis CI workflow, we should create the configuration file (.travis.yml). 
This file will tell Travis CI 



You can customize your build environment and add the set of steps in this file. 

Travis CI uses .travis.yml file in the root of your repository to learn about your project environment, how you want your builds to be executed, what kind of tests to perform and other information like emails, Campfire and IRC rooms to notify about build failures.

This is the file we are going to use:

```
language: python
python:
  - "3.5"
# command to install dependencies
install:
  - pip install -r requirements.txt
# command to run tests
script:
  - export PYTHONPATH=$PYTHONPATH:$(pwd)
  - python app/tests/app-test.py
```

<h3><span style="color: #0000CD;">Setup Our Git</span></h3> 

Now that we finished writing our code, the .gitignore file, the test and the Travis CI configuration, we need to create a Github repository and link our Travis CI to our Github account in order to import the new project.


```
git init
git add .
git commit -m "First commit"
git remote add origin <remote repository URL>
git push origin master
```

Don't forget to change  the <remote repository URL> by its real value, you can get it from your Github repository:

![repository URL](images/url.png "repository URL")

# Setup Travis CI

Go to your Travis CI dashboard, connect your Github account then sync your repositories and add the new project. This will generate your first build and you can see whether your build passes or no.

![Build History ](images/buids.png "Build History")

After every code commit, a build will start automatically and you will be notified by email on its status.


<h3><span style="color: #0000CD;">   Managing Pull Requests</span></h3> 

Now, if your are working on a different branch than the master, which is the case for all development teams, you need to make a pull request then merge your code. Let's try to test this:

Create the branch "dev" on your local machine:

```
git checkout -b dev
```

Add your modifications then push them to the dev branch:

```
git push origin dev
```

Once your modifications are added to the remote dev branch, Circle CI will trigger a new build for the dev branch and you will notice that you can make a pull request on the master branch:

![Git Pull Request](images/pull.png "Git Pull Request")

If the pull request is accepted an merged with the master branch, our CI tool will trigger a new build under the "Pull Requests" tab:

![Circle CI Pull Request Build](images/pr.png "Circle CI Pull Request Build")



<h3><span style="color: #0000CD;">  Conclusion </span></h3> 

During this practice lab, we created an application using Python using Virtualenv for the environment isolation then we created a Github repository for this application and linked it to our Travis CI account.

The continuous build and test were described in our .travis.yml file. 

It is possible to add more advanced features like ChatOps using Slack, IRC or any alternative, add more steps to your integration pipeline like creating a Docker image or deploying to a Azure Web App.. etc


























================================================
FILE: Labfiles/DevOps200.1x-PracticesandPrinciples/Mod03/python-ci-example-master/__init__.py
================================================
[Empty file]


================================================
FILE: Labfiles/DevOps200.1x-PracticesandPrinciples/Mod03/python-ci-example-master/requirements.txt
================================================
[Empty file]


================================================
FILE: Labfiles/DevOps200.1x-PracticesandPrinciples/Mod03/python-ci-example-master/.travis.yml
================================================
language: python
python:
  - "3.5"
# command to install dependencies
install:
  - pip install -r requirements.txt
# command to run tests
script:
  - export PYTHONPATH=$PYTHONPATH:$(pwd)
  - python app/tests/app-test.py



================================================
FILE: Labfiles/DevOps200.1x-PracticesandPrinciples/Mod03/python-ci-example-master/app/__init__.py
================================================
[Empty file]


================================================
FILE: Labfiles/DevOps200.1x-PracticesandPrinciples/Mod03/python-ci-example-master/app/src/__init__.py
================================================
[Empty file]


================================================
FILE: Labfiles/DevOps200.1x-PracticesandPrinciples/Mod03/python-ci-example-master/app/src/app.py
================================================
def my_function(param1, param2):
    return param1 + param2
    
    



================================================
FILE: Labfiles/DevOps200.1x-PracticesandPrinciples/Mod03/python-ci-example-master/app/tests/__init__.py
================================================
[Empty file]


================================================
FILE: Labfiles/DevOps200.1x-PracticesandPrinciples/Mod03/python-ci-example-master/app/tests/app-test.py
================================================
import unittest
from app.src.app import my_function


class MyTest(unittest.TestCase):
    def test_my_function(self):
        self.assertEqual(my_function(1, 1), 2)
        self.assertEqual(my_function(1, -1), 0)
        self.assertEqual(my_function(0, 0), 0)
        self.assertEqual(my_function(-1, -1), -2)
        self.assertEqual(my_function(1.0, 1), 2)        
        self.assertEqual(my_function(1.1, 1.1), 2.2)        
        
        
        
if __name__ == '__main__':
    unittest.main()        



================================================
FILE: Labfiles/DevOps200.1x-PracticesandPrinciples/Mod04/load_testing_locust-master/README.md
================================================
# Introduction


There are several types of test types in software engineering and load testing is one of the most common tests.

The purpose of this test is checking if a software can handle what it was designed to handle and identifying the blottleneck and any performance degradation. 

This is performed by putting demand on a application under normal and peak load conditions. Load testing could help you determine some metrics like the Mean Time Between Failure (MTBF) and Mean Time To Failure (MTTF).

According to [Microsoft guide Performance Testing Guidance for Web Applications](https://msdn.microsoft.com/en-us/library/bb924357.aspx), a load test enables you to measure response times, throughput rates, and resource-utilization levels, and to identify your application’s breaking point, assuming that the breaking point occurs below the peak load condition. 

As a conclusion, load testing helps you to:

- Determine the throughput required to support the anticipated peak production load.
- Determine the adequacy of a hardware environment.
- Evaluate the adequacy of a load balancer.
- Detect concurrency issues.
- Detect functionality errors under load.
- Collect data for scalability and capacity-planning purposes.
- Help to determine how many users the application can handle before performance is compromised.
- Help to determine how much load the hardware can handle before resource utilization limits are exceeded. 

Gatling, JMeter, Locust are some of the load testing tools.

In this practice lab, we are going to create a simple REST API and write some load test scenarios.

# Preparing Our Application


In this practice lab, we are going to create a minimal RESTful API using the Flask framework. Our application will let the user get a list of software testing types or add a new type.

The purpose of this lab is to load test our RESTful API using Locust.

We are going to use:

- Python 3.5
- Python Virtualenv to create an isolated environment for our application
- Locust: A load testing framework

This is the structure of our project folder:

```
app/
├── app.py
└── __init__.py
__init__.py
.gitignore
```

You can also download the .gitignore file from [this repository](https://github.com/github/gitignore/blob/master/Python.gitignore).

Let's start by creating the virtual environment for our Flask application. 

```
python3 -m venv /path/to/new/virtual/environment
```

If you are using Linux.

```
c:\>c:\Python35\python -m venv c:\path\to\myenv
```

If you are using Windows.

If everything is fine, let's activate it:

```
. /path/to/new/virtual/environment/bin/activate
```

In order to use Flask, you need to install it from the Python Package Index using PIP:

```
pip install flask
```

Let's create our application files:

```
mkdir project
wget -O .gitignore "https://github.com/github/gitignore/blob/master/Python.gitignore" 2> templog
touch __init__.py
mkdir app
touch app/app.py
touch app/__init__.py
```

Paste this code inside the app.py file:

```
from flask import Flask, jsonify, request

app = Flask(__name__)

testing_types = [
  { 'name': 'unit testing', 'description': 'testing individual units of source code' }
]


@app.route('/tests')
def get_tests():
  return jsonify(testing_types)


@app.route('/tests', methods=['POST'])
def add_test():
  testing_types.append(request.get_json())
  return '', 204
  
  
  
if __name__ == '__main__':
    app.run(debug=True)  
    
```

The above code has two functions:
- get_tests : Used to get the list of tests from the testing\_types dictionary 
- add_tests : Used to add a test to the testing\_types dictionary
    
Our initial dictionary contains one test type:

```
testing_types = [
  { 'name': 'unit testing', 'description': 'testing individual units of source code' }
]
```

In order to run our API, type:

```
python app/app.py
```

You should see something similar to the following output:

```
python app/app.py 
 * Running on http://127.0.0.1:5000/ (Press CTRL+C to quit)
 * Restarting with stat
 * Debugger is active!
 * Debugger PIN: 179-596-761
```

Our web server runs on: http://127.0.0.1:5000/ and in order to test it we can use a curl request. You can use your terminal or a graphical tool like Postman, Swagger or any other alternative.

This is our curl request to get the testing types list:

```
curl -X GET  http://127.0.0.1:5000/tests
```

At this stage, it should return:

```
[
  {
    "description": "testing individual units of source code", 
    "name": "unit testing"
  }
]
```

Let's try adding another type of test:

```
curl -X POST -H "Content-Type: application/json" -d '{
  "name": "load testing",
  "description": "checking if a software can handle the expected load"
}' http://localhost:5000/tests
```

After executing the last POST request, we can verify using another GET:

```
curl -X GET  http://127.0.0.1:5000/tests
```

We should see the two types of tests:

```
[
  {
    "description": "testing individual units of source code", 
    "name": "unit testing"
  }, 
  {
    "description": "checking if a software can handle the expected load", 
    "name": "load testing"
  }
]
```

# Load Testing Our RESTful API Using Locust

Locust is described as an easy-to-use, distributed, user load testing tool. It is intended for load-testing web sites (or other systems) and figuring out how many concurrent users a system can handle.

A swarm of locusts will attack your website. The behavior of each locust (or test user if you will) is defined by you and the swarming process is monitored from a web UI in real-time. This will help you battle test and identify bottlenecks in your code before letting real users in.

Since Locust is event-based, it is possible to support concurrent users on a single machine. 

Start by installing Locust:

```
pip install locustio
```

Now in the project root directory, create the locustfile.py file that will describe our testing scenarios:

```
from locust import HttpLocust, TaskSet, task

class UserBehavior(TaskSet):

    @task
    def get_tests(self):
        self.client.get("/tests")
        
    @task
    def put_tests(self):
        self.client.post("/tests", {
						  "name": "load testing",
						  "description": "checking if a software can handle the expected load"
						})
        

class WebsiteUser(HttpLocust):
    task_set = UserBehavior
    
```

In this file we told Locust to create two test tasks:

- The first one will execute a GET request to list the test types we stored in our dictionary
- The second one will execute a POST request to add a new testing type

Now start our Flask API using ``` python app/app.py ``` and Locust using ``` locust --host=http://localhost:5000 ```.

Make sure to change ``` http://localhost:5000 ``` by the real address of your application.

The web interface of Locust is available by default at ``` http://localhost:8089 ```

![Locust Home Page](images/locust_home.png "Locust Home Page")

Say our API should support a number of 10000 user. We can start a test by giving this value to Locust, using the web interface, as well as the the hatch rate which is the number of users spawned by second.

After clicking on "Start spawning", you can see different live statistics about your tasks like the number of requests, fails, and other statistics about the response time.

![Locust Statistics](images/locust_stats.png "Locust Statistics")

Using the Charts view, we can determine some fact-based conclusions. For instance, if we don't accept a response time greater than 450ms, we know that our application cannot handle more than 117 request per second and that the max number of simultaneous users should be less than 350.


# Conclusion

In this practice lab, we created a RESTful API and tested its performance using Locust. Using the results from our tests, we determined how our API can behave with a certain number of users and requests.

Load testing is an important practice since it prevents organizations from downtimes and failures due to errors like the timeout or memory overflows. Load testing gives meaningful results when tests are done against a similar environment to production (configurations, code, physical resources like disks and memory ..etc).



================================================
FILE: Labfiles/DevOps200.1x-PracticesandPrinciples/Mod04/load_testing_locust-master/__init__.py
================================================
[Empty file]


================================================
FILE: Labfiles/DevOps200.1x-PracticesandPrinciples/Mod04/load_testing_locust-master/locustfile.py
================================================
from locust import HttpLocust, TaskSet, task

class UserBehavior(TaskSet):

    @task
    def get_tests(self):
        self.client.get("/tests")
        
    @task
    def put_tests(self):
        self.client.post("/tests", {
						  "name": "load testing",
						  "description": "checking if a software can handle the expected load"
						})
        

class WebsiteUser(HttpLocust):
    task_set = UserBehavior



================================================
FILE: Labfiles/DevOps200.1x-PracticesandPrinciples/Mod04/load_testing_locust-master/app/__init__.py
================================================
[Empty file]


================================================
FILE: Labfiles/DevOps200.1x-PracticesandPrinciples/Mod04/load_testing_locust-master/app/app.py
================================================
from flask import Flask, jsonify, request

app = Flask(__name__)

testing_types = [
  { 'name': 'unit testing', 'description': 'testing individual units of source code' }
]

@app.route('/')
def hello():
  return jsonify({"message": "hello"})
  

@app.route('/tests')
def get_tests():
  return jsonify(testing_types)


@app.route('/tests', methods=['POST'])
def add_test():
  testing_types.append(request.get_json())
  return '', 204
  
  
  
if __name__ == '__main__':
    app.run(debug=True)  
    
    
    
    
    




================================================
FILE: Labfiles/DevOps200.2x-InfrastructureasCode/DeployusingChef/final/default.rb
================================================
#
# Cookbook Name:: mrpapp-2
# Recipe:: default
#
# Copyright (c) 2015 The Authors, All Rights Reserved.

# Runs apt-get update
include_recipe "apt"

# Add the Open JDK apt repo
apt_repository 'openJDK' do
    uri 'ppa:openjdk-r/ppa'
    distribution 'trusty'
end

# Install JDK and JRE
apt_package 'openjdk-8-jdk-headless' do
    action :install
end

apt_package 'openjdk-8-jre-headless' do
    action :install
end

# Set Java environment variables
ENV['JAVA_HOME'] = "/usr/lib/jvm/java-8-openjdk-amd64"
ENV['PATH'] = "#{ENV['PATH']}:/usr/lib/jvm/java-8-openjdk-amd64/bin"

# Install MongoDB
apt_package 'mongodb' do
    action :install
end

# Install Tomcat 7
apt_package 'tomcat7' do
    action :install
end

# Load MongoDB data 
remote_file 'mongodb_data' do
    source 'https://github.com/Microsoft/PartsUnlimitedMRP/raw/master/deploy/MongoRecords.js'
    path './MongoRecords.js'
    action :create
    notifies :run, "script[mongodb_import]", :immediately
end

script 'mongodb_import' do
    interpreter "bash"
    action :nothing
    code "mongo ordering MongoRecords.js"
end

# Set tomcat port 
script 'tomcat_port' do 
    interpreter "bash"
    code "sed -i 's/Connector port=\".*\" protocol=\"HTTP\\/1.1\"$/Connector port=\"#{node['tomcat']['mrp_port']}\" protocol=\"HTTP\\/1.1\"/g' /etc/tomcat7/server.xml"
    not_if "grep 'Connector port=\"#{node['tomcat']['mrp_port']}\" protocol=\"HTTP/1.1\"$' /etc/tomcat7/server.xml"
    notifies :restart, "service[tomcat7]", :immediately
end

# Install the MRP app, restart the Tomcat service if necessary
remote_file 'mrp_app' do
    source 'https://github.com/Microsoft/PartsUnlimitedMRP/raw/master/builds/mrp.war'
    path '/var/lib/tomcat7/webapps/mrp.war'
    action :create
    notifies :restart, "service[tomcat7]", :immediately
end

# Ensure Tomcat is running
service 'tomcat7' do
    action :start
end

remote_file 'ordering_service' do
    source 'https://github.com/Microsoft/PartsUnlimitedMRP/raw/master/builds/ordering-service-0.1.0.jar'
    path './ordering-service-0.1.0.jar'
    action :create
    notifies :run, "script[stop_ordering_service]", :immediately
end

# Kill the ordering service
script 'stop_ordering_service' do
    interpreter "bash"
    # Only run when notifed
    action :nothing
    code "pkill -f ordering-service"
    only_if "pgrep -f ordering-service"
end

# Start the ordering service. 
script 'start_ordering_service' do
    interpreter "bash"
    code "/usr/lib/jvm/java-8-openjdk-amd64/bin/java -jar ordering-service-0.1.0.jar &"
    not_if "pgrep -f ordering-service"
end



================================================
FILE: Labfiles/DevOps200.2x-InfrastructureasCode/Puppet/final/init.pp
================================================
class mrpapp {
  class { 'configuremongodb': }
  class { 'configurejava': }
  class { 'createuserandgroup': }
  class { 'configuretomcat': }
  class { 'deploywar': }
  class { 'orderingservice': }
}

class configuremongodb {
  include wget
  class { 'mongodb': }->

  wget::fetch { 'mongorecords':
    source => 'https://raw.githubusercontent.com/Microsoft/PartsUnlimitedMRP/master/deploy/MongoRecords.js',
    destination => '/tmp/MongoRecords.js',
    timeout => 0,
  }->
  exec { 'insertrecords':
    command => 'mongo ordering /tmp/MongoRecords.js',
    path => '/usr/bin:/usr/sbin',
    unless => 'test -f /tmp/initcomplete'
  }->
  file { '/tmp/initcomplete':
    ensure => 'present',
  }
}

class configurejava {
  include apt
  $packages = ['openjdk-8-jdk', 'openjdk-8-jre']

  apt::ppa { 'ppa:openjdk-r/ppa': }->
  package { $packages:
     ensure => 'installed',
  }
}


class createuserandgroup {

group { 'tomcat':
  ensure => 'present',
  gid    => '10003',
 }

user { 'tomcat':
  ensure           => 'present',
  gid              => '10003',
  home             => '/tomcat',
  password         => '!',
  password_max_age => '99999',
  password_min_age => '0',
  uid              => '1003',
 }

}

class configuretomcat {
  class { 'tomcat': }
  require createuserandgroup


 tomcat::instance { 'default':
  catalina_home => '/var/lib/tomcat7',
  install_from_source => false,
  package_name => ['tomcat7','tomcat7-admin'],
 }->

 tomcat::config::server::tomcat_users {
 'tomcat':
   catalina_base => '/var/lib/tomcat7',
   element  => 'user',
   password => 'password',
   roles => ['manager-gui','manager-jmx','manager-script','manager-status'];
 'tomcat7':
   catalina_base => '/var/lib/tomcat7',
   element  => 'user',
   password => 'password',
   roles => ['manager-gui','manager-jmx','manager-script','manager-status'];
 }->

 tomcat::config::server::connector { 'tomcat7-http':
  catalina_base => '/var/lib/tomcat7',
  port => '9080',
  protocol => 'HTTP/1.1',
  connector_ensure => 'present',
  server_config => '/etc/tomcat7/server.xml',
 }->

 tomcat::service { 'default':
  use_jsvc => false,
  use_init => true,
  service_name => 'tomcat7',
 }

}

class deploywar {
  require configuretomcat

  tomcat::war { 'mrp.war':
    catalina_base => '/var/lib/tomcat7',
    war_source => 'https://raw.githubusercontent.com/Microsoft/PartsUnlimitedMRP/master/builds/mrp.war',
  }

 file { '/var/lib/tomcat7/webapps/':
   path => '/var/lib/tomcat7/webapps/',
   ensure => 'directory',
   recurse => 'true',
   mode => '777',
 }

}

class orderingservice {
  package { 'openjdk-7-jre':
    ensure => 'installed',
  }

  file { '/opt/mrp':
    ensure => 'directory'
  }->
  wget::fetch { 'orderingsvc':
    source => 'https://raw.githubusercontent.com/Microsoft/PartsUnlimitedMRP/master/builds/ordering-service-0.1.0.jar',
    destination => '/opt/mrp/ordering-service.jar',
    cache_dir => '/var/cache/wget',
    timeout => 0,
  }->
  
  exec { 'stoporderingservice':
    command => "pkill -f ordering-service",
    path => '/bin:/usr/bin:/usr/sbin',
    onlyif => "pgrep -f ordering-service"
  }->

  exec { 'stoptomcat':
    command => 'service tomcat7 stop',
    path => '/bin:/usr/bin:/usr/sbin',
    onlyif => "test -f /etc/init.d/tomcat7",
  }->
  exec { 'orderservice':
    command => 'java -jar /opt/mrp/ordering-service.jar &',
    path => '/usr/bin:/usr/sbin:/usr/lib/jvm/java-8-openjdk-amd64/bin',
  }->
  exec { 'wait':
    command => 'sleep 20',
    path => '/bin',
    notify => Tomcat::Service['default']
  }
}



================================================
FILE: src/Backend/IntegrationService/gradlew
================================================
#!/usr/bin/env bash

##############################################################################
##
##  Gradle start up script for UN*X
##
##############################################################################

# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
DEFAULT_JVM_OPTS=""

APP_NAME="Gradle"
APP_BASE_NAME=`basename "$0"`

# Use the maximum available, or set MAX_FD != -1 to use that value.
MAX_FD="maximum"

warn ( ) {
    echo "$*"
}

die ( ) {
    echo
    echo "$*"
    echo
    exit 1
}

# OS specific support (must be 'true' or 'false').
cygwin=false
msys=false
darwin=false
case "`uname`" in
  CYGWIN* )
    cygwin=true
    ;;
  Darwin* )
    darwin=true
    ;;
  MINGW* )
    msys=true
    ;;
esac

# For Cygwin, ensure paths are in UNIX format before anything is touched.
if $cygwin ; then
    [ -n "$JAVA_HOME" ] && JAVA_HOME=`cygpath --unix "$JAVA_HOME"`
fi

# Attempt to set APP_HOME
# Resolve links: $0 may be a link
PRG="$0"
# Need this for relative symlinks.
while [ -h "$PRG" ] ; do
    ls=`ls -ld "$PRG"`
    link=`expr "$ls" : '.*-> \(.*\)$'`
    if expr "$link" : '/.*' > /dev/null; then
        PRG="$link"
    else
        PRG=`dirname "$PRG"`"/$link"
    fi
done
SAVED="`pwd`"
cd "`dirname \"$PRG\"`/" >&-
APP_HOME="`pwd -P`"
cd "$SAVED" >&-

CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar

# Determine the Java command to use to start the JVM.
if [ -n "$JAVA_HOME" ] ; then
    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
        # IBM's JDK on AIX uses strange locations for the executables
        JAVACMD="$JAVA_HOME/jre/sh/java"
    else
        JAVACMD="$JAVA_HOME/bin/java"
    fi
    if [ ! -x "$JAVACMD" ] ; then
        die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
    fi
else
    JAVACMD="java"
    which java >/dev/null 2>&1 || die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
fi

# Increase the maximum file descriptors if we can.
if [ "$cygwin" = "false" -a "$darwin" = "false" ] ; then
    MAX_FD_LIMIT=`ulimit -H -n`
    if [ $? -eq 0 ] ; then
        if [ "$MAX_FD" = "maximum" -o "$MAX_FD" = "max" ] ; then
            MAX_FD="$MAX_FD_LIMIT"
        fi
        ulimit -n $MAX_FD
        if [ $? -ne 0 ] ; then
            warn "Could not set maximum file descriptor limit: $MAX_FD"
        fi
    else
        warn "Could not query maximum file descriptor limit: $MAX_FD_LIMIT"
    fi
fi

# For Darwin, add options to specify how the application appears in the dock
if $darwin; then
    GRADLE_OPTS="$GRADLE_OPTS \"-Xdock:name=$APP_NAME\" \"-Xdock:icon=$APP_HOME/media/gradle.icns\""
fi

# For Cygwin, switch paths to Windows format before running java
if $cygwin ; then
    APP_HOME=`cygpath --path --mixed "$APP_HOME"`
    CLASSPATH=`cygpath --path --mixed "$CLASSPATH"`

    # We build the pattern for arguments to be converted via cygpath
    ROOTDIRSRAW=`find -L / -maxdepth 1 -mindepth 1 -type d 2>/dev/null`
    SEP=""
    for dir in $ROOTDIRSRAW ; do
        ROOTDIRS="$ROOTDIRS$SEP$dir"
        SEP="|"
    done
    OURCYGPATTERN="(^($ROOTDIRS))"
    # Add a user-defined pattern to the cygpath arguments
    if [ "$GRADLE_CYGPATTERN" != "" ] ; then
        OURCYGPATTERN="$OURCYGPATTERN|($GRADLE_CYGPATTERN)"
    fi
    # Now convert the arguments - kludge to limit ourselves to /bin/sh
    i=0
    for arg in "$@" ; do
        CHECK=`echo "$arg"|egrep -c "$OURCYGPATTERN" -`
        CHECK2=`echo "$arg"|egrep -c "^-"`                                 ### Determine if an option

        if [ $CHECK -ne 0 ] && [ $CHECK2 -eq 0 ] ; then                    ### Added a condition
            eval `echo args$i`=`cygpath --path --ignore --mixed "$arg"`
        else
            eval `echo args$i`="\"$arg\""
        fi
        i=$((i+1))
    done
    case $i in
        (0) set -- ;;
        (1) set -- "$args0" ;;
        (2) set -- "$args0" "$args1" ;;
        (3) set -- "$args0" "$args1" "$args2" ;;
        (4) set -- "$args0" "$args1" "$args2" "$args3" ;;
        (5) set -- "$args0" "$args1" "$args2" "$args3" "$args4" ;;
        (6) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" ;;
        (7) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" ;;
        (8) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" "$args7" ;;
        (9) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" "$args7" "$args8" ;;
    esac
fi

# Split up the JVM_OPTS And GRADLE_OPTS values into an array, following the shell quoting and substitution rules
function splitJvmOpts() {
    JVM_OPTS=("$@")
}
eval splitJvmOpts $DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS
JVM_OPTS[${#JVM_OPTS[*]}]="-Dorg.gradle.appname=$APP_BASE_NAME"

exec "$JAVACMD" "${JVM_OPTS[@]}" -classpath "$CLASSPATH" org.gradle.wrapper.GradleWrapperMain "$@"



================================================
FILE: src/Backend/IntegrationService/gradlew.bat
================================================
@if "%DEBUG%" == "" @echo off
@rem ##########################################################################
@rem
@rem  Gradle startup script for Windows
@rem
@rem ##########################################################################

@rem Set local scope for the variables with windows NT shell
if "%OS%"=="Windows_NT" setlocal

@rem Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
set DEFAULT_JVM_OPTS=

set DIRNAME=%~dp0
if "%DIRNAME%" == "" set DIRNAME=.
set APP_BASE_NAME=%~n0
set APP_HOME=%DIRNAME%

@rem Find java.exe
if defined JAVA_HOME goto findJavaFromJavaHome

set JAVA_EXE=java.exe
%JAVA_EXE% -version >NUL 2>&1
if "%ERRORLEVEL%" == "0" goto init

echo.
echo ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
echo.
echo Please set the JAVA_HOME variable in your environment to match the
echo location of your Java installation.

goto fail

:findJavaFromJavaHome
set JAVA_HOME=%JAVA_HOME:"=%
set JAVA_EXE=%JAVA_HOME%/bin/java.exe

if exist "%JAVA_EXE%" goto init

echo.
echo ERROR: JAVA_HOME is set to an invalid directory: %JAVA_HOME%
echo.
echo Please set the JAVA_HOME variable in your environment to match the
echo location of your Java installation.

goto fail

:init
@rem Get command-line arguments, handling Windowz variants

if not "%OS%" == "Windows_NT" goto win9xME_args
if "%@eval[2+2]" == "4" goto 4NT_args

:win9xME_args
@rem Slurp the command line arguments.
set CMD_LINE_ARGS=
set _SKIP=2

:win9xME_args_slurp
if "x%~1" == "x" goto execute

set CMD_LINE_ARGS=%*
goto execute

:4NT_args
@rem Get arguments from the 4NT Shell from JP Software
set CMD_LINE_ARGS=%$

:execute
@rem Setup the command line

set CLASSPATH=%APP_HOME%\gradle\wrapper\gradle-wrapper.jar

@rem Execute Gradle
"%JAVA_EXE%" %DEFAULT_JVM_OPTS% %JAVA_OPTS% %GRADLE_OPTS% "-Dorg.gradle.appname=%APP_BASE_NAME%" -classpath "%CLASSPATH%" org.gradle.wrapper.GradleWrapperMain %CMD_LINE_ARGS%

:end
@rem End local scope for the variables with windows NT shell
if "%ERRORLEVEL%"=="0" goto mainEnd

:fail
rem Set variable GRADLE_EXIT_CONSOLE if you need the _script_ return code instead of
rem the _cmd.exe /c_ return code!
if  not "" == "%GRADLE_EXIT_CONSOLE%" exit 1
exit /b 1

:mainEnd
if "%OS%"=="Windows_NT" endlocal

:omega



================================================
FILE: src/Backend/IntegrationService/IntegrationService.iml
================================================
<?xml version="1.0" encoding="UTF-8"?>
<module external.linked.project.id="IntegrationService" external.linked.project.path="$MODULE_DIR$" external.root.project.path="$MODULE_DIR$" external.system.id="GRADLE" external.system.module.group="" external.system.module.version="unspecified" type="JAVA_MODULE" version="4">
  <component name="NewModuleRootManager" inherit-compiler-output="false">
    <output url="file://$MODULE_DIR$/build/classes/main" />
    <output-test url="file://$MODULE_DIR$/build/classes/test" />
    <exclude-output />
    <content url="file://$MODULE_DIR$">
      <sourceFolder url="file://$MODULE_DIR$/src/main/java" isTestSource="false" />
      <sourceFolder url="file://$MODULE_DIR$/src/test/java" isTestSource="true" />
      <sourceFolder url="file://$MODULE_DIR$/src/main/resources" type="java-resource" />
      <sourceFolder url="file://$MODULE_DIR$/src/test/resources" type="java-test-resource" />
      <excludeFolder url="file://$MODULE_DIR$/.gradle" />
      <excludeFolder url="file://$MODULE_DIR$/build" />
    </content>
    <orderEntry type="inheritedJdk" />
    <orderEntry type="sourceFolder" forTests="false" />
    <orderEntry type="library" exported="" name="Gradle: org.springframework.boot:spring-boot-starter:1.2.2.RELEASE" level="project" />
    <orderEntry type="library" exported="" name="Gradle: org.springframework:spring-web:4.1.5.RELEASE" level="project" />
    <orderEntry type="library" exported="" name="Gradle: org.springframework:spring-context:4.1.5.RELEASE" level="project" />
    <orderEntry type="library" exported="" name="Gradle: com.fasterxml.jackson.core:jackson-databind:2.4.5" level="project" />
    <orderEntry type="library" exported="" name="Gradle: com.microsoft.azure:azure-storage:2.0.0" level="project" />
    <orderEntry type="library" exported="" name="Gradle: commons-logging:commons-logging:1.2" level="project" />
    <orderEntry type="library" exported="" name="Gradle: org.springframework:spring-core:4.1.5.RELEASE" level="project" />
    <orderEntry type="library" exported="" name="Gradle: org.springframework:spring-beans:4.1.5.RELEASE" level="project" />
    <orderEntry type="library" exported="" name="Gradle: aopalliance:aopalliance:1.0" level="project" />
    <orderEntry type="library" exported="" name="Gradle: org.springframework:spring-aop:4.1.5.RELEASE" level="project" />
    <orderEntry type="library" exported="" name="Gradle: org.springframework:spring-expression:4.1.5.RELEASE" level="project" />
    <orderEntry type="library" exported="" name="Gradle: org.springframework.boot:spring-boot:1.2.2.RELEASE" level="project" />
    <orderEntry type="library" exported="" name="Gradle: org.yaml:snakeyaml:1.14" level="project" />
    <orderEntry type="library" exported="" name="Gradle: org.springframework.boot:spring-boot-autoconfigure:1.2.2.RELEASE" level="project" />
    <orderEntry type="library" exported="" name="Gradle: org.slf4j:slf4j-api:1.7.10" level="project" />
    <orderEntry type="library" exported="" name="Gradle: org.slf4j:jcl-over-slf4j:1.7.10" level="project" />
    <orderEntry type="library" exported="" name="Gradle: org.slf4j:jul-to-slf4j:1.7.10" level="project" />
    <orderEntry type="library" exported="" name="Gradle: org.slf4j:log4j-over-slf4j:1.7.10" level="project" />
    <orderEntry type="library" exported="" name="Gradle: ch.qos.logback:logback-core:1.1.2" level="project" />
    <orderEntry type="library" exported="" name="Gradle: ch.qos.logback:logback-classic:1.1.2" level="project" />
    <orderEntry type="library" exported="" name="Gradle: org.springframework.boot:spring-boot-starter-logging:1.2.2.RELEASE" level="project" />
    <orderEntry type="library" exported="" name="Gradle: com.fasterxml.jackson.core:jackson-annotations:2.4.0" level="project" />
    <orderEntry type="library" exported="" name="Gradle: com.fasterxml.jackson.core:jackson-core:2.4.5" level="project" />
    <orderEntry type="library" exported="" name="Gradle: org.apache.commons:commons-lang3:3.3.2" level="project" />
  </component>
</module>


================================================
FILE: src/Backend/IntegrationService/gradle/wrapper/gradle-wrapper.properties
================================================
#Fri Mar 06 11:46:13 NZDT 2015
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-1.11-bin.zip



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/Constants.java
================================================
package integration;


public class Constants {
    //Ensure that the constants file cannot be initialized.
    private Constants(){}

    public static final int SCHEDULED_INTERVAL = 30000;
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/Main.java
================================================
package integration;

import integration.scheduled.UpdateProductProcessTask;
import integration.scheduled.CreateOrderProcessTask;
import org.springframework.boot.SpringApplication;

public class Main {
	public static void main(String[] args) {
		//Adding the scheduled task classes to the spring application to run in background threads.
		SpringApplication.run(new Object[] { CreateOrderProcessTask.class, UpdateProductProcessTask.class }, new String[0]);
	}
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/infrastructure/ConfigurationHelpers.java
================================================
package integration.infrastructure;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Properties;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;

/**
 * The ConfigurationHelpers class is responsible for abstracting the logic of getting property types based on property names.
 */
public class ConfigurationHelpers {
//    private final static Logger log = MakeLogger();
//     private static Logger MakeLogger(){
//         try{
//             return LoggerFactory.getLogger(ConfigurationHelpers.class);
//         }
//         catch(Exception ex)
//         {
//             return null;
//         }
//     }


    public static String getString(String name) {
        try {
            return s_props.getProperty(name);
        } catch (Exception ex)
        {
            //log.error("An error occurred resolving string " + name + ". Exception : " + ex.toString());
        }
        return "";
    }

    /**
     * return the configuration value in the type of a integer
     * @param name - the name/key of the configuration value.
     * @return the configuration value associated with the name/key provided.
     */
    public static int getInt(String name) {
        try {
            String prop = s_props.getProperty(name);
            return Integer.parseInt(prop);
        } catch (Exception ex) {
            //log.error("An error occurred resolving int " + name + ". Exception : " + ex.toString());
        }
        return 0;
    }

    /**
     * Load the configuration properties for the propFileName
     * @param propFileName - name of the properties file
     * @return a Properties object containing all key value pairs from the properties file.
     * @throws java.io.IOException
     */
    private static Properties getPropValues(String propFileName) throws IOException {

        Properties props = new Properties();

        ClassLoader classLoader = ConfigurationHelpers.class.getClassLoader();
        InputStream inputStream = classLoader.getResourceAsStream(propFileName);

        props.load(inputStream);
        if (inputStream == null) {
            throw new FileNotFoundException("property file '" + propFileName + "' not found in the classpath");
        }

        return props;
    }

    private static Properties getProperties() {
        return s_props;
    }

    static {
        try {
            s_props = getPropValues("application.properties");
        } catch (Exception e) {
            s_props = new Properties();
        }
    }

    private static Properties s_props;
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/infrastructure/ConfigurationManager.java
================================================
package integration.infrastructure;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.util.Properties;

/**
 * The ConfigurationManager class is responsible for wrapping calls to the application properties.
 */
public class ConfigurationManager {

    public ConfigurationManager()
    {
    }

    public static String getAzureStorageConnectionString() {
        return ConfigurationHelpers.getString("azure.storage.connectionstring");
    }

    public static String getMrpEndpoint() {
        return ConfigurationHelpers.getString("mrp.endpoint");
    }

    public static String getAzureOrderQueue() {
        return ConfigurationHelpers.getString("azure.storage.queue.orders");
    }

    public static String getAzureInventoryQueue(){
        return ConfigurationHelpers.getString("azure.storage.queue.inventory");
    }

    public static int getAzureQueueTimeout() {
        return ConfigurationHelpers.getInt("azure.storage.queue.message");
    }

}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/models/QueueResponse.java
================================================
package integration.models;

import com.microsoft.azure.storage.StorageException;
import com.microsoft.azure.storage.queue.CloudQueueMessage;
import java.io.IOException;

/**
 * This class is responsible for wrapping responses from the queue service.
 * @param <T>
 */
public class QueueResponse <T> {

    private final CloudQueueMessage queueMessage;
    private final T responseBody;

    public QueueResponse(CloudQueueMessage queueMessage, T responseBody){
        this.queueMessage = queueMessage;
        this.responseBody = responseBody;
    }

    public CloudQueueMessage getQueueMessage() {
        return queueMessage;
    }

    public T getResponseBody() throws StorageException, IOException {
        return responseBody;
    }
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/models/mrp/CatalogItem.java
================================================
package integration.models.mrp;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;

@JsonIgnoreProperties(ignoreUnknown = true)
public class CatalogItem {
    private String skuNumber;
    private String description;
    private String unit;
    private String price;
    private int inventory;
    private int leadTime;

    public String getSkuNumber() {
        return skuNumber;
    }

    public String getDescription() {
        return description;
    }

    public String getUnit() {
        return unit;
    }

    public String getPrice() {
        return price;
    }

    public int getInventory() {
        return inventory;
    }

    public int getLeadTime() {
        return leadTime;
    }
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/models/mrp/DeliveryAddress.java
================================================
package integration.models.mrp;

public class DeliveryAddress {

    private String street;
    private String city;
    private String state;
    private String postalCode;
    private String specialInstructions;

    public DeliveryAddress() {
    }

    public DeliveryAddress(String street, String city, String state, String postalCode) {
        setStreet(street);
        setCity(city);
        setState(state);
        setPostalCode(postalCode);
    }

    public String getStreet() {
        return street;
    }

    public void setStreet(String street) {
        this.street = street;
    }

    public String getCity() {
        return city;
    }

    public void setCity(String city) {
        this.city = city;
    }

    public String getState() {
        return state;
    }

    public void setState(String state) {
        this.state = state;
    }

    public String getPostalCode() {
        return postalCode;
    }

    public void setPostalCode(String postalCode) {
        this.postalCode = postalCode;
    }

    public String getSpecialInstructions() {
        return specialInstructions;
    }

    public void setSpecialInstructions(String specialInstructions) {
        this.specialInstructions = specialInstructions;
    }
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/models/mrp/Order.java
================================================
package integration.models.mrp;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;

@JsonIgnoreProperties(ignoreUnknown = true)
public class Order {
    private String orderId;
    private String quoteId;
    private String orderDate;
    private String status;

    public Order() {

    }

    public String getOrderId() {
        return orderId;
    }

    public void setOrderId(String orderId) {
        this.orderId = orderId;
    }

    public String getQuoteId() {
        return quoteId;
    }

    public void setQuoteId(String quoteId) {
        this.quoteId = quoteId;
    }

    public String getOrderDate() {
        return orderDate;
    }

    public void setOrderDate(String orderDate) {
        this.orderDate = orderDate;
    }

    public String getStatus() {
        return status;
    }

    public void setStatus(String status) {
        this.status = status;
    }
}


================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/models/mrp/PhoneInfo.java
================================================
package integration.models.mrp;

public class PhoneInfo {
    private String phoneNumber;
    private String kind;

    public PhoneInfo() {

    }

    public PhoneInfo(String phoneNumber) {
        setPhoneNumber(phoneNumber);
    }

    public String getPhoneNumber() {
        return phoneNumber;
    }

    public void setPhoneNumber(String phoneNumber) {
        this.phoneNumber = phoneNumber;
    }

    public String getKind() {
        return kind;
    }

    public void setKind(String kind) {
        this.kind = kind;
    }
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/models/mrp/Quote.java
================================================
package integration.models.mrp;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import integration.models.website.OrderItem;
import integration.models.website.OrderMessage;

import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.ArrayList;
import java.util.List;

@JsonIgnoreProperties(ignoreUnknown = true)
public class Quote {
    private String quoteId;
    private String customerName;
    private String dealerName;
    private String validUntil;
    private String city;
    private String postalCode;
    private String state;
    private double totalCost;
    private double discount;
    private List<QuoteItemInfo> quoteItems;

    public Quote() {
    }

    public Quote(OrderMessage message) {
        DateFormat dateFormat = new SimpleDateFormat("yyyy-MM-ddTHH:mm:ss");
        Calendar c = Calendar.getInstance();
        c.add(Calendar.DATE, 1);
    
        this.customerName = message.getCustomerName();
        this.dealerName = "Website";
        this.setCity(message.getCity());
        this.postalCode = message.getPostalCode();
        this.state = message.getState();
        this.totalCost = message.getTotalCost();
        this.discount = message.getDiscount();
        this.validUntil = dateFormat.format(c);
        this.quoteItems = new ArrayList<QuoteItemInfo>();
        
        for (OrderItem orderItem : message.getItems()){
            QuoteItemInfo quoteItem = new QuoteItemInfo(orderItem);
            this.quoteItems.add(quoteItem);
        }
    }

    public String getQuoteId() {
        return quoteId;
    }

    public void setQuoteId(String quoteId) {
        this.quoteId = quoteId;
    }

    public String getCustomerName() {
        return customerName;
    }

    public void setCustomerName(String customerName) {
        this.customerName = customerName;
    }

    public String getDealerName() {
        return dealerName;
    }

    public void setDealerName(String dealerName) {
        this.dealerName = dealerName;
    }

    public String getCity() {
        return city;
    }

    public void setCity(String city) {
        this.city = city;
    }

    public String getPostalCode() {
        return postalCode;
    }

    public void setPostalCode(String postalCode) {
        this.postalCode = postalCode;
    }

    public String getState() {
        return state;
    }

    public void setState(String state) {
        this.state = state;
    }

    public List<QuoteItemInfo> getQuoteItems() {
        return quoteItems;
    }

    public void setQuoteItems(List<QuoteItemInfo> quoteItems) {
        this.quoteItems = quoteItems;
    }

    public double getTotalCost() {
        return totalCost;
    }

    public void setTotalCost(double totalCost) {
        this.totalCost = totalCost;
    }

    public double getDiscount() {
        return discount;
    }

    public void setDiscount(double discount) {
        this.discount = discount;
    }

    public String getValidUntil() {
        return validUntil;
    }

    public void setValidUntil(String validUntil) {
        this.validUntil = validUntil;
    }
}




================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/models/mrp/QuoteItemInfo.java
================================================
package integration.models.mrp;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;
import integration.models.website.OrderItem;

@JsonIgnoreProperties(ignoreUnknown = true)
public class QuoteItemInfo {
    private String skuNumber;
    private double amount;

    public QuoteItemInfo(){
    }

    public QuoteItemInfo(OrderItem orderItem){
        setSkuNumber(orderItem.getSkuNumber());
        setAmount(orderItem.getPrice());
    }

    public String getSkuNumber() {
        return skuNumber;
    }

    public void setSkuNumber(String skuNumber) {
        this.skuNumber = skuNumber;
    }

    public double getAmount() {
        return amount;
    }

    public void setAmount(double amount) {
        this.amount = amount;
    }
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/models/mrp/ShipmentEventInfo.java
================================================
package integration.models.mrp;

public class ShipmentEventInfo {
    private String date;
    private String comments;

    public String getDate() {
        return date;
    }

    public void setDate(String date) {
        this.date = date;
    }

    public String getComments() {
        return comments;
    }

    public void setComments(String comments) {
        this.comments = comments;
    }
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/models/mrp/ShipmentRecord.java
================================================
package integration.models.mrp;

import integration.models.website.OrderMessage;

import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.ArrayList;
import java.util.List;

public class ShipmentRecord {
    private String orderId;
    private String deliveryDate;
    private List<ShipmentEventInfo> events;
    private DeliveryAddress deliveryAddress;
    private String contactName;
    private PhoneInfo primaryContactPhone;
    private PhoneInfo alternateContactPhone;

    public ShipmentRecord() {
        this.setEvents(new ArrayList());
    }

    public ShipmentRecord(OrderMessage message, String orderId) {
        DateFormat dateFormat = new SimpleDateFormat("yyyy-MM-ddTHH:mm:ss");
        Calendar c = Calendar.getInstance();
        c.add(Calendar.DATE, 14);
        
        setEvents(new ArrayList());
        setOrderId(orderId);
        setDeliveryDate(dateFormat.format(c));
        setDeliveryAddress(new DeliveryAddress(message.getAddress(), message.getCity(), message.getState(), message.getPostalCode()));
        setContactName(message.getCustomerName());
        setPrimaryContactPhone(new PhoneInfo(message.getPhone()));
    }

    public String getOrderId() {
        return orderId;
    }

    public void setOrderId(String orderId) {
        this.orderId = orderId;
    }

    public String getDeliveryDate() {
        return deliveryDate;
    }

    public void setDeliveryDate(String deliveryDate) {
        this.deliveryDate = deliveryDate;
    }

    public List<ShipmentEventInfo> getEvents() {
        return events;
    }

    public void setEvents(List<ShipmentEventInfo> events) {
        this.events = events;
    }

    public DeliveryAddress getDeliveryAddress() {
        return deliveryAddress;
    }

    public void setDeliveryAddress(DeliveryAddress deliveryAddress) {
        this.deliveryAddress = deliveryAddress;
    }

    public String getContactName() {
        return contactName;
    }

    public void setContactName(String contactName) {
        this.contactName = contactName;
    }

    public PhoneInfo getPrimaryContactPhone() {
        return primaryContactPhone;
    }

    public void setPrimaryContactPhone(PhoneInfo primaryContactPhone) {
        this.primaryContactPhone = primaryContactPhone;
    }

    public PhoneInfo getAlternateContactPhone() {
        return alternateContactPhone;
    }

    public void setAlternateContactPhone(PhoneInfo alternateContactPhone) {
        this.alternateContactPhone = alternateContactPhone;
    }
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/models/website/OrderItem.java
================================================
package integration.models.website;

/**
 * This class is used to describe a product of the order from the website.
 */
public class OrderItem {
    private String skuNumber;
    private double price;

    public String getSkuNumber() {
        return skuNumber;
    }

    public void setSkuNumber(String skuNumber) {
        this.skuNumber = skuNumber;
    }

    public double getPrice() {
        return price;
    }

    public void setPrice(double price) {
        this.price = price;
    }
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/models/website/OrderMessage.java
================================================
package integration.models.website;

import com.fasterxml.jackson.annotation.JsonIgnoreProperties;

import java.util.List;

/**
 * This class is responsible for describing the order message that we receive from the website.
 */
@JsonIgnoreProperties(ignoreUnknown = true)
public class OrderMessage {
    private String customerName;
    private String dealerName;
    private String orderDate;
    private String address;
    private String country;
    private String phone;
    private String city;
    private String postalCode;
    private String state;
    private double totalCost;
    private double discount;
    private List<OrderItem> items;

    public String getCustomerName() {
        return customerName;
    }

    public void setCustomerName(String customerName) {
        this.customerName = customerName;
    }

    public String getDealerName() {
        return dealerName;
    }

    public void setDealerName(String dealerName) {
        this.dealerName = dealerName;
    }

    public String getOrderDate() {
        return orderDate;
    }

    public void setOrderDate(String orderDate) {
        this.orderDate = orderDate;
    }

    public String getAddress() {
        return address;
    }

    public void setAddress(String address) {
        this.address = address;
    }

    public String getCountry() {
        return country;
    }

    public void setCountry(String country) {
        this.country = country;
    }

    public String getPhone() {
        return phone;
    }

    public void setPhone(String phone) {
        this.phone = phone;
    }

    public String getCity() {
        return city;
    }

    public void setCity(String city) {
        this.city = city;
    }

    public String getPostalCode() {
        return postalCode;
    }

    public void setPostalCode(String postalCode) {
        this.postalCode = postalCode;
    }

    public String getState() {
        return state;
    }

    public void setState(String state) {
        this.state = state;
    }

    public double getTotalCost() {
        return totalCost;
    }

    public void setTotalCost(double totalCost) {
        this.totalCost = totalCost;
    }

    public List<OrderItem> getItems() {
        return items;
    }

    public void setItems(List<OrderItem> items) {
        this.items = items;
    }

    public double getDiscount() {
        return discount;
    }

    public void setDiscount(double discount) {
        this.discount = discount;
    }
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/models/website/ProductItem.java
================================================
package integration.models.website;

import integration.models.mrp.CatalogItem;

/**
 * This class is used to describe the updates to the website product.
 */
public class ProductItem {

    private String skuNumber;
    private int inventory;
    private int leadTime;

    public ProductItem(){

    }

    public ProductItem(CatalogItem catalogItem){
        setInventory(catalogItem.getInventory());
        setSkuNumber(catalogItem.getSkuNumber());
        setLeadTime(catalogItem.getLeadTime());
    }

    public int getInventory() {
        return inventory;
    }

    public void setInventory(int inventory) {
        this.inventory = inventory;
    }

    public String getSkuNumber() {
        return skuNumber;
    }

    public void setSkuNumber(String skuNumber) {
        this.skuNumber = skuNumber;
    }

    public int getLeadTime() {
        return leadTime;
    }

    public void setLeadTime(int leadTime) {
        this.leadTime = leadTime;
    }
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/models/website/ProductMessage.java
================================================
package integration.models.website;

import integration.models.mrp.CatalogItem;
import java.util.ArrayList;
import java.util.List;

/**
 * This class is used to describe the list of products for the website to update.
 */
public class ProductMessage {

    private List<ProductItem> productList;

    public ProductMessage(){
        setProductList(new ArrayList<ProductItem>());
    }

    public ProductMessage(List<CatalogItem> catalogItems) {
        this();
        for(CatalogItem catalogItem: catalogItems){
            ProductItem inventoryItem = new ProductItem(catalogItem);
            this.productList.add(inventoryItem);
        }
    }

    public List<ProductItem> getProductList() {
        return productList;
    }

    public void setProductList(List<ProductItem> productList) {
        this.productList = productList;
    }
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/scheduled/CreateOrderProcessTask.java
================================================
package integration.scheduled;

import integration.Constants;
import integration.infrastructure.ConfigurationManager;
import integration.models.QueueResponse;
import integration.models.website.OrderMessage;
import integration.services.MrpConnectService;
import integration.services.QueueService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.scheduling.annotation.EnableScheduling;
import org.springframework.scheduling.annotation.Scheduled;

/**
 * Scheduled task for retrieving any new orders from the queue and integrating them into the MRP system.
 */
@EnableScheduling
public class CreateOrderProcessTask {

    private final static Logger log = LoggerFactory.getLogger(CreateOrderProcessTask.class);

    @Scheduled(fixedDelay = Constants.SCHEDULED_INTERVAL)
    public void scheduledTask() {
        try {
            String endpoint = ConfigurationManager.getMrpEndpoint();
            MrpConnectService mrpService = new MrpConnectService(endpoint);
            QueueService queueService = new QueueService(ConfigurationManager.getAzureOrderQueue(), OrderMessage.class);
            QueueResponse<OrderMessage> response;

            while ((response = queueService.getQueueMessage()) != null) {
                log.info("Found queue message. MessageId :" + response.getQueueMessage().getMessageId());
                mrpService.createNewOrder(response.getResponseBody());
                log.info("Created new order in MRP system. MessageId :" + response.getQueueMessage().getMessageId());
                queueService.deleteQueueMessage(response.getQueueMessage());
                log.info("Message removed from queue. MessageId :" + response.getQueueMessage().getMessageId());
            }
        } catch (Exception ex) {
            log.error("Exception thrown while retrieving queue message :" + ex.toString());
        }
    }
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/scheduled/UpdateProductProcessTask.java
================================================
package integration.scheduled;

import integration.Constants;
import integration.infrastructure.ConfigurationManager;
import integration.models.mrp.CatalogItem;
import integration.models.website.ProductMessage;
import integration.services.MrpConnectService;
import integration.services.QueueService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.scheduling.annotation.EnableScheduling;
import org.springframework.scheduling.annotation.Scheduled;

import java.util.List;

/**
 * Scheduled tasks for querying the MRP system for catalog items and sending an update to the website.
 */
@EnableScheduling
public class UpdateProductProcessTask {
    private final static Logger log = LoggerFactory.getLogger(UpdateProductProcessTask.class);

    @Scheduled(fixedDelay = Constants.SCHEDULED_INTERVAL)
    public void scheduledTask() {
        try{
            MrpConnectService mrpService = new MrpConnectService(ConfigurationManager.getMrpEndpoint());
            List<CatalogItem> catalogItems = mrpService.getCatalogItems();

            if (catalogItems != null && !catalogItems.isEmpty()){
                ProductMessage message = new ProductMessage(catalogItems);
                QueueService queueService = new QueueService(ConfigurationManager.getAzureInventoryQueue(), ProductMessage.class);
                queueService.addQueueMessage(message);
            }
        }
        catch (Exception ex)
        {
            log.error("Exception thrown while processing catalog item inventory :" + ex.toString());
        }
    }
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/services/MrpConnectService.java
================================================
package integration.services;

import integration.models.website.OrderMessage;
import integration.models.mrp.CatalogItem;
import integration.models.mrp.Order;
import integration.models.mrp.Quote;
import integration.models.mrp.ShipmentRecord;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.util.UriComponentsBuilder;
import java.net.MalformedURLException;
import java.util.ArrayList;
import java.util.List;

/**
 * This service is responsible for communication to the MRP system.
 */
public class MrpConnectService {

    private final static Logger log = LoggerFactory.getLogger(MrpConnectService.class);
    private String hostName;
    private RestTemplate restTemplate;

    public MrpConnectService(String hostName) {
        this.hostName = hostName;
        this.restTemplate = new RestTemplate();
    }

    /**
     * Crates a new Quote, Order and Shipment in the MRP system
     * @param message the new order message from website
     * @throws MalformedURLException
     */
    public void createNewOrder(OrderMessage message) throws MalformedURLException {
        Quote quote = createQuote(message);
        log.info("Quote Created. Quote Id : " + quote.getQuoteId());
        Order order = createOrder(quote.getQuoteId());
        log.info("Order Created. Quote Id : " + quote.getQuoteId() + "  Order Id : " + order.getOrderId());
        createShipment(message, order.getOrderId());
        log.info("Shipment Created. Quote Id : " + quote.getQuoteId() + "  Order Id : " + order.getOrderId());
    }

    /**
     * Uses the customer address to build a shipment for the orderId.
     * @param message - Website Order
     * @param orderId - Id of order created in the MRP system
     * @throws MalformedURLException
     */
    private void createShipment(OrderMessage message, String orderId) throws MalformedURLException {
        String uri = UriComponentsBuilder.fromUriString(hostName).path("shipments").build().toUriString();
        ShipmentRecord newShipmentRecord = new ShipmentRecord(message, orderId);
        restTemplate.postForObject(uri, newShipmentRecord, ShipmentRecord.class);
    }

    /**
     * Posts the quote id to the MRP system to confirm the order.
     * @param quoteId - Id of the quote that you wish to fulfill.
     * @return Order - the newly created order including the id created in the MRP system.
     */
    private Order createOrder(String quoteId) {
        String uri = UriComponentsBuilder.fromUriString(hostName).path("orders").queryParam("fromQuote", quoteId).build().toUriString();
        Order createdOrder = restTemplate.postForObject(uri, null, Order.class);
        return createdOrder;
    }

    /**
     * Takes all of the information about the order to create the inital quote.
     * @param message - Website Order
     * @return Quote - the newly created quote including the id created in the MRP system.
     */
    private Quote createQuote(OrderMessage message) {
        String uri = UriComponentsBuilder.fromUriString(hostName).path("quotes").build().toUriString();
        Quote newQuote = new Quote(message);
        Quote createdQuote = restTemplate.postForObject(uri, newQuote, Quote.class);
        return createdQuote;
    }

    /**
     * Queries the MRP system for the catalog.
     * @return List<CatalogItem> - list of all catalog items in the MRP system.
     */
    public List<CatalogItem> getCatalogItems() {
        String uri = UriComponentsBuilder.fromUriString(hostName).pathSegment("catalog").build().toUriString();

        ArrayList<CatalogItem> CatalogList = new ArrayList<CatalogItem>();
        for (CatalogItem catalog : restTemplate.getForObject(uri, CatalogItem[].class)){
            CatalogList.add(catalog);
        }
        return CatalogList;
    }
}


================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/services/QueueFactory.java
================================================
package integration.services;

import com.microsoft.azure.storage.CloudStorageAccount;
import com.microsoft.azure.storage.StorageException;
import com.microsoft.azure.storage.queue.CloudQueue;
import com.microsoft.azure.storage.queue.CloudQueueClient;
import integration.infrastructure.ConfigurationManager;

import java.net.URISyntaxException;
import java.security.InvalidKeyException;
import java.util.Map;
import java.util.concurrent.ConcurrentHashMap;

/**
 * The queue factory is responsible for initializing and locating the queues a thread safe manner.
 */
public class QueueFactory {

    private static Map<String, CloudQueue> s_queueDictionary;

    /**
     * get queue will return the named queue, initializing a new queue in the case it does not already exist.
     * @param queueKey - The name of the cloud queue to search for.
     * @return com.microsoft.azure.storage.queue.CloudQueue
     * @throws StorageException
     * @throws URISyntaxException
     * @throws InvalidKeyException
     */
    public static CloudQueue getQueue(String queueKey) throws StorageException, URISyntaxException, InvalidKeyException {
        if (s_queueDictionary == null) {
            // http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ConcurrentHashMap.html
            // Ensuring if we are thread safe for setting and getting cloud queues.
            s_queueDictionary = new ConcurrentHashMap();
        }

        if (s_queueDictionary.containsKey(queueKey)) {
            return s_queueDictionary.get(queueKey);
        } else {
            // Retrieve storage account from connection-string.
            CloudStorageAccount storageAccount = CloudStorageAccount.parse(ConfigurationManager.getAzureStorageConnectionString());
            // Create the queue client.
            CloudQueueClient queueClient = storageAccount.createCloudQueueClient();
            // Retrieve a reference to a queue.
            CloudQueue queue = queueClient.getQueueReference(queueKey);
            // Create the queue if it doesn't already exist.
            queue.createIfNotExists();

            s_queueDictionary.put(queueKey, queue);
            return queue;
        }
    }
}



================================================
FILE: src/Backend/IntegrationService/src/main/java/integration/services/QueueService.java
================================================
package integration.services;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.microsoft.azure.storage.StorageException;
import com.microsoft.azure.storage.queue.CloudQueue;
import com.microsoft.azure.storage.queue.CloudQueueMessage;
import integration.infrastructure.ConfigurationManager;
import integration.models.QueueResponse;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.net.URISyntaxException;
import java.security.InvalidKeyException;

/**
 * The queue service responsible for resolving all calls to azure queues.
 * @param <T> T is the message type is used for the serialization and de-serialization.
 */
public class QueueService <T> {

    private final static Logger log = LoggerFactory.getLogger(MrpConnectService.class);
    private final String queueName;
    private Class<T> valueType;

    public QueueService(String queueName, Class<T> valueType) {

        this.queueName = queueName;
        this.valueType = valueType;
    }

    /**
     * Retrieve a message off the configured queue.
     * @return A queue response object that host a reference to the queue message and the de-serialized content.
     * If not queue message is found or the message is malformed, null will be returned.
     * @throws StorageException
     * @throws URISyntaxException
     * @throws InvalidKeyException
     */
    public QueueResponse getQueueMessage() throws StorageException, URISyntaxException, InvalidKeyException {
        CloudQueue queue = QueueFactory.getQueue(queueName);
        CloudQueueMessage message = queue.retrieveMessage(ConfigurationManager.getAzureQueueTimeout(), null /*options*/, null /*opContext*/);

        if (message == null) {
            return null;
        }

        // If a queue message is successfully retrieved de-serialize it and return.
        String messageString = message.getMessageContentAsString();
        try {
            ObjectMapper mapper = new ObjectMapper();
            T messageContent = mapper.readValue(messageString, this.valueType);
            QueueResponse response = new QueueResponse(message, messageContent);
            return response;
        } catch (IOException ex) {
            log.error("An error occurred de-serializing queue message to OrderMessage. Serialized Object : " + messageString);
            deleteQueueMessage(message);
            return null;
        }
    }

    /**
     * Delete a processed message off the configured queue
     * @param message - The cloud queue message that is returned during retrieval.
     * @throws StorageException
     * @throws URISyntaxException
     * @throws InvalidKeyException
     */
    public void deleteQueueMessage(CloudQueueMessage message) throws StorageException, URISyntaxException, InvalidKeyException {
        CloudQueue queue = QueueFactory.getQueue(queueName);
        queue.deleteMessage(message);
    }

    /**
     * Serialize and add a object to the configured queue.
     * @param queueContent - the object to add to the queue.
     * @throws StorageException
     * @throws URISyntaxException
     * @throws InvalidKeyException
     * @throws JsonProcessingException
     */
    public void addQueueMessage(T queueContent) throws StorageException, URISyntaxException, InvalidKeyException, JsonProcessingException {
        CloudQueue queue = QueueFactory.getQueue(queueName);
        ObjectMapper mapper = new ObjectMapper();
        byte[] queueByteContent = mapper.writeValueAsBytes(queueContent);
        CloudQueueMessage message = new CloudQueueMessage(queueByteContent);
        queue.addMessage(message);
    }
}



================================================
FILE: src/Backend/IntegrationService/src/main/resources/application.properties
================================================
azure.storage.connectionstring: DefaultEndpointsProtocol=https;AccountName=datastoreleef;AccountKey=AbUxxr9hvFqz62sqnoxi82WO1B6YsnBEwvJhweJ3g2efrKfZ+MfSJ6WvCpT/rQ+wfh/dCoLb4MrByP3AsQLIQQ==
azure.storage.queue.orders: orders
azure.storage.queue.inventory: product
azure.storage.queue.message: 300

mrp.endpoint: http://127.0.0.1:8080/

logging.file: integration-service.log
logging.level.org.springframework.web: INFO


================================================
FILE: src/Backend/OrderService/README
================================================
﻿Fabrikam Development Status

At this point, a skeleton of the service REST API is in place. Quotes can be created and queried, catalog item can be
added to the catalog, dealers added and listed, and orders can be created from quotes.

Here are some sample Fiddler requests (the user agent can be anything, of course):

List items in the catalog:

GET /catalog HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080

Add an item to the catalog with SKU # 'MRP-004':

POST /catalog HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080
Content-Type: application/json

{"skuNumber" : "MRP-0004", "description" : "Break Calipers Guide Pin Boot Kit", "price" : 8.99, "inventory" : 10, "leadTime" : 5}


Get a list of all the known dealers in the system:

GET /dealers HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080


Add a new dealer called 'BigJoe':

POST /dealers HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080
Content-Type: application/json

{"name":"BigJoe","contact":"John Doe","address":"123 Main Street, Redmond, WA 98052","email":"jdoe@tempuri.org", "phone":"425-555-1212"}


Get information on a given quote:

GET /quotes/quote-1 HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080


Get all quotes for customers containing the string 'Little Inn'

GET /quotes?name=Little%20Inn HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080


Delete a given quote from the system:

DELETE /quotes/quote-1 HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080


Create a new quote (the quote id is returned in the Location header of the response):

POST /quotes HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080
Content-Type: application/json

{"customerName":"The Little Inn by the Bay",
  "dealerName":"BigJoe",
  "comments":"Here is your quote for our top-of-the-line fridge unit.",
  "terms":"60 days",
  "validUntil":"12/1/14",
  "unitDescription":"CoolnessExtreme",
  "additionalItems":[
    {"skuNumber":"MRP-0001","amount":100.0},
    {"skuNumber":"MRP-0002","amount":2.0}
  ],
  "unitCost":12000.0,
  "totalCost":18050.0,
  "discount":1500.0,
  "height":2.5,
  "width":5.0,
  "depth":8.0,
  "unit":"meters",
  "purpose":"Refrigerator",
  "ambientPeak":25.0,
  "ambientAverage":21.0,
  "buildOnSite":true,
  "city":"Wellfleet",
  "postalCode":"02667",
  "state":"MA"}


Update an existing quote:

PUT /quotes/quote-1 HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080
Content-Type: application/json

{"customerName":"The Little Inn by the Bay",
  "dealerName":"LittleJoe",
  "comments":"Here is your quote for our top-of-the-line fridge unit.",
  "terms":"60 days",
  "validUntil":"12/1/14",
  "unitDescription":"CoolnessExtreme",
  "additionalItems":[
    {"skuNumber":"ACC-0001", "amount":150.0},
    {"skuNumber":"ACC-0003", "amount":1.0},
    {"skuNumber":"ACC-0004", "amount":50.0}
  ],
  "unitCost":12000.0,
  "totalCost":18050.0,
  "discount":1500.0,
  "height":2.5,
  "width":5.0,
  "depth":8.0,
  "unit":"meters",
  "purpose":"Refrigerator",
  "ambientPeak":25.0,
  "ambientAverage":21.0,
  "buildOnSite":true,
  "city":"Wellfleet",
  "postalCode":"02667",
  "state":"MA"}


Get the given order:

GET /orders/order-quote-1  HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080

Get all orders for a given dealer, identified by name:

GET /orders?dealer=BigJoe  HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080

Get all orders for a given dealer, identified by name. Filter by status.

GET /orders?dealer=BigJoe&status=Confirmed  HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080


Create a new order from a quote. The order id is returned in the 'Location' header of the response.

POST /orders?fromQuote=quote-1  HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080


List all shipments, regardless of status

GET /shipments  HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080

List all shipments of a given status

GET /shipments?status=Created  HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080

Get the details of a specific shipment record

GET /shipments/order-quote-1  HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080

Create a new shipment record (only one per order)

POST /shipments  HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080
Content-Type: application/json

{ "orderId":"order-quote-1",
   "contactName":"Jane Smith",
   "deliveryAddress":{"street":"123 Main St.","city":"Redmond","state":"WA","postalCode":"98052","specialInstructions":"Look for a yellow house" },
   "primaryContactPhone": {"kind":"Mobile", "phoneNumber":"425-555-1212"},
   "alternateContactPhone": {"kind":"Work", "phoneNumber":"425-555-1213"},
   "events": [] }

Modify an existing shipment record. Missing fields will be overwritten with null

PUT /shipments/order-quote-1  HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080
Content-Type: application/json

{ "orderId":"order-quote-1",
   "contactName":"John Smith",
   "deliveryAddress":{"street":"123 Main St.","city":"Redmond","state":"WA","postalCode":"98052","specialInstructions":"Look for a yellow house" },
   "primaryContactPhone": {"kind":"Mobile", "phoneNumber":"425-555-1212"},
   "alternateContactPhone": {"kind":"Work", "phoneNumber":"425-555-1213"},
   "events": [] }

Add a comment to the shipment.

POST /shipments/order-quote-1/events HTTP/1.1
User-Agent: Fiddler
Host: localhost:8080
Content-Type: application/json

{"comments":"Coming from Fiddler"}




On OS X, curl is the best tool to use, but it's more complex. The 'scripts' directory contains a number of files to test things with.

To go through dealer and catalog update, quote creation and update, then order creation, issue the following from
the scripts directory:

./setup.sh
./update.sh
./createorder.sh



================================================
FILE: src/Backend/OrderService/README.md
================================================
# Building the OrderService #
The following command is used to build the OderService WAR file.

## Clone the GitHub repository ###

Prior to building, you should have cloned the git repository with the following command (assuming you have git installed already).

### Installing git ###
The following provides examples for obtaining git for Windows and Ubuntu Linux.

#### Windows ####
By far the easiest way to get git for Windows is use the GitHub installer that provides the command line interface along with a Windows client that makes managing and working with git easier and visual.

Navigate to [http://windows.github.com](http://windows.github.com).  Click on the 'Download GitHub for Windows'

When done, there will be 2 GitHub shortcuts created.  Open the "Git Shell".  This will be a PowerShell session with git and [POSH-GIT](https://github.com/dahlbyk/posh-git) ready to go.

```
cd <Some Local Path Where Child Directories will be Git Repositories>

# clone the repository and replace the <http://.....> path with the URL of the git repository
git clone https://github.com/Microsoft/PartsUnlimitedMRP.git 

#switch to the path.
cd PartsUnlimitedMRP
```
After this you will be in the Root of the cloned repository ready to build.

#### Linux ####
Assuming you are using Ubuntu 14+, utilize the Debian package manager.

```
cd ~/
# update package info from Ubuntu
sudo apt-get update

# run the install for git
sudo apt-get install git

# clone the repository and replace the <http://.....> path with the URL of the git repository
git clone https://github.com/Microsoft/PartsUnlimitedMRP.git

# switch to the path
cd PartsUnlimitedMRP
```
After this you will be in the Root of the cloned repository ready to build.

## Building ##

The following commands are used to build the ```ordering-service-0.1.0.jar``` file from the sources located in the clone of the git repository.

change to the ```./src/Backend/OrderService``` directory.


### Windows ###
From a PowerShell or CMD shell, run the following command.

```
.\gradlew.bat build

```

### Linux ###

```
#make sure you have the JDK installed. assumes Ubuntu 14.04 LTS.
sudo apt-get install default-jdk
```

At this point exit and restart your bash session to pick up the new settings. Or run ```. .profile  ``` from your home ```~/```

```
# ensure the 'gradlew' is executable
chmod +x gradlew

# now build...
./gradlew build
```

The build will run for a bit and will also run some tests. When done, the output it placed in the ```./builds/libs``` directory.

This creates the ```ordering-service-0.1.0.jar``` in the ```./build/libs``` directory.

## Cleaning all builds ##

### Windows ###
Run ```removeBuild.bat``` to remove the ```./build``` and the ```./buildSrc/build``` directories.

### Linux ###

Run the following native command:
```
rm -rf ./build ./buildSrc/build
```




================================================
FILE: src/Backend/OrderService/gradlew
================================================
#!/usr/bin/env bash

##############################################################################
##
##  Gradle start up script for UN*X
##
##############################################################################

# Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
DEFAULT_JVM_OPTS=""

APP_NAME="Gradle"
APP_BASE_NAME=`basename "$0"`

# Use the maximum available, or set MAX_FD != -1 to use that value.
MAX_FD="maximum"

warn ( ) {
    echo "$*"
}

die ( ) {
    echo
    echo "$*"
    echo
    exit 1
}

# OS specific support (must be 'true' or 'false').
cygwin=false
msys=false
darwin=false
case "`uname`" in
  CYGWIN* )
    cygwin=true
    ;;
  Darwin* )
    darwin=true
    ;;
  MINGW* )
    msys=true
    ;;
esac

# For Cygwin, ensure paths are in UNIX format before anything is touched.
if $cygwin ; then
    [ -n "$JAVA_HOME" ] && JAVA_HOME=`cygpath --unix "$JAVA_HOME"`
fi

# Attempt to set APP_HOME
# Resolve links: $0 may be a link
PRG="$0"
# Need this for relative symlinks.
while [ -h "$PRG" ] ; do
    ls=`ls -ld "$PRG"`
    link=`expr "$ls" : '.*-> \(.*\)$'`
    if expr "$link" : '/.*' > /dev/null; then
        PRG="$link"
    else
        PRG=`dirname "$PRG"`"/$link"
    fi
done
SAVED="`pwd`"
cd "`dirname \"$PRG\"`/" >&-
APP_HOME="`pwd -P`"
cd "$SAVED" >&-

CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar

# Determine the Java command to use to start the JVM.
if [ -n "$JAVA_HOME" ] ; then
    if [ -x "$JAVA_HOME/jre/sh/java" ] ; then
        # IBM's JDK on AIX uses strange locations for the executables
        JAVACMD="$JAVA_HOME/jre/sh/java"
    else
        JAVACMD="$JAVA_HOME/bin/java"
    fi
    if [ ! -x "$JAVACMD" ] ; then
        die "ERROR: JAVA_HOME is set to an invalid directory: $JAVA_HOME

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
    fi
else
    JAVACMD="java"
    which java >/dev/null 2>&1 || die "ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.

Please set the JAVA_HOME variable in your environment to match the
location of your Java installation."
fi

# Increase the maximum file descriptors if we can.
if [ "$cygwin" = "false" -a "$darwin" = "false" ] ; then
    MAX_FD_LIMIT=`ulimit -H -n`
    if [ $? -eq 0 ] ; then
        if [ "$MAX_FD" = "maximum" -o "$MAX_FD" = "max" ] ; then
            MAX_FD="$MAX_FD_LIMIT"
        fi
        ulimit -n $MAX_FD
        if [ $? -ne 0 ] ; then
            warn "Could not set maximum file descriptor limit: $MAX_FD"
        fi
    else
        warn "Could not query maximum file descriptor limit: $MAX_FD_LIMIT"
    fi
fi

# For Darwin, add options to specify how the application appears in the dock
if $darwin; then
    GRADLE_OPTS="$GRADLE_OPTS \"-Xdock:name=$APP_NAME\" \"-Xdock:icon=$APP_HOME/media/gradle.icns\""
fi

# For Cygwin, switch paths to Windows format before running java
if $cygwin ; then
    APP_HOME=`cygpath --path --mixed "$APP_HOME"`
    CLASSPATH=`cygpath --path --mixed "$CLASSPATH"`

    # We build the pattern for arguments to be converted via cygpath
    ROOTDIRSRAW=`find -L / -maxdepth 1 -mindepth 1 -type d 2>/dev/null`
    SEP=""
    for dir in $ROOTDIRSRAW ; do
        ROOTDIRS="$ROOTDIRS$SEP$dir"
        SEP="|"
    done
    OURCYGPATTERN="(^($ROOTDIRS))"
    # Add a user-defined pattern to the cygpath arguments
    if [ "$GRADLE_CYGPATTERN" != "" ] ; then
        OURCYGPATTERN="$OURCYGPATTERN|($GRADLE_CYGPATTERN)"
    fi
    # Now convert the arguments - kludge to limit ourselves to /bin/sh
    i=0
    for arg in "$@" ; do
        CHECK=`echo "$arg"|egrep -c "$OURCYGPATTERN" -`
        CHECK2=`echo "$arg"|egrep -c "^-"`                                 ### Determine if an option

        if [ $CHECK -ne 0 ] && [ $CHECK2 -eq 0 ] ; then                    ### Added a condition
            eval `echo args$i`=`cygpath --path --ignore --mixed "$arg"`
        else
            eval `echo args$i`="\"$arg\""
        fi
        i=$((i+1))
    done
    case $i in
        (0) set -- ;;
        (1) set -- "$args0" ;;
        (2) set -- "$args0" "$args1" ;;
        (3) set -- "$args0" "$args1" "$args2" ;;
        (4) set -- "$args0" "$args1" "$args2" "$args3" ;;
        (5) set -- "$args0" "$args1" "$args2" "$args3" "$args4" ;;
        (6) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" ;;
        (7) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" ;;
        (8) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" "$args7" ;;
        (9) set -- "$args0" "$args1" "$args2" "$args3" "$args4" "$args5" "$args6" "$args7" "$args8" ;;
    esac
fi

# Split up the JVM_OPTS And GRADLE_OPTS values into an array, following the shell quoting and substitution rules
function splitJvmOpts() {
    JVM_OPTS=("$@")
}
eval splitJvmOpts $DEFAULT_JVM_OPTS $JAVA_OPTS $GRADLE_OPTS
JVM_OPTS[${#JVM_OPTS[*]}]="-Dorg.gradle.appname=$APP_BASE_NAME"

exec "$JAVACMD" "${JVM_OPTS[@]}" -classpath "$CLASSPATH" org.gradle.wrapper.GradleWrapperMain "$@"



================================================
FILE: src/Backend/OrderService/gradlew.bat
================================================
@if "%DEBUG%" == "" @echo off
@rem ##########################################################################
@rem
@rem  Gradle startup script for Windows
@rem
@rem ##########################################################################

@rem Set local scope for the variables with windows NT shell
if "%OS%"=="Windows_NT" setlocal

@rem Add default JVM options here. You can also use JAVA_OPTS and GRADLE_OPTS to pass JVM options to this script.
set DEFAULT_JVM_OPTS=

set DIRNAME=%~dp0
if "%DIRNAME%" == "" set DIRNAME=.
set APP_BASE_NAME=%~n0
set APP_HOME=%DIRNAME%

@rem Find java.exe
if defined JAVA_HOME goto findJavaFromJavaHome

set JAVA_EXE=java.exe
%JAVA_EXE% -version >NUL 2>&1
if "%ERRORLEVEL%" == "0" goto init

echo.
echo ERROR: JAVA_HOME is not set and no 'java' command could be found in your PATH.
echo.
echo Please set the JAVA_HOME variable in your environment to match the
echo location of your Java installation.

goto fail

:findJavaFromJavaHome
set JAVA_HOME=%JAVA_HOME:"=%
set JAVA_EXE=%JAVA_HOME%/bin/java.exe

if exist "%JAVA_EXE%" goto init

echo.
echo ERROR: JAVA_HOME is set to an invalid directory: %JAVA_HOME%
echo.
echo Please set the JAVA_HOME variable in your environment to match the
echo location of your Java installation.

goto fail

:init
@rem Get command-line arguments, handling Windowz variants

if not "%OS%" == "Windows_NT" goto win9xME_args
if "%@eval[2+2]" == "4" goto 4NT_args

:win9xME_args
@rem Slurp the command line arguments.
set CMD_LINE_ARGS=
set _SKIP=2

:win9xME_args_slurp
if "x%~1" == "x" goto execute

set CMD_LINE_ARGS=%*
goto execute

:4NT_args
@rem Get arguments from the 4NT Shell from JP Software
set CMD_LINE_ARGS=%$

:execute
@rem Setup the command line

set CLASSPATH=%APP_HOME%\gradle\wrapper\gradle-wrapper.jar

@rem Execute Gradle
"%JAVA_EXE%" %DEFAULT_JVM_OPTS% %JAVA_OPTS% %GRADLE_OPTS% "-Dorg.gradle.appname=%APP_BASE_NAME%" -classpath "%CLASSPATH%" org.gradle.wrapper.GradleWrapperMain %CMD_LINE_ARGS%

:end
@rem End local scope for the variables with windows NT shell
if "%ERRORLEVEL%"=="0" goto mainEnd

:fail
rem Set variable GRADLE_EXIT_CONSOLE if you need the _script_ return code instead of
rem the _cmd.exe /c_ return code!
if  not "" == "%GRADLE_EXIT_CONSOLE%" exit 1
exit /b 1

:mainEnd
if "%OS%"=="Windows_NT" endlocal

:omega



================================================
FILE: src/Backend/OrderService/removeBuild.bat
================================================
rd /S /Q build > NUL 2>&1
rd /S /Q buildSrc\build > NUL 2>&1


================================================
FILE: src/Backend/OrderService/version.properties
================================================
major = 0
minor = 1



================================================
FILE: src/Backend/OrderService/buildSrc/src/main/groovy/com/microsoft/appinsights/BuildInformationTask.groovy
================================================

package com.microsoft.appinsights

import java.text.SimpleDateFormat
import org.gradle.api.DefaultTask
import org.gradle.api.tasks.*


class BuildInformationTask extends DefaultTask
{
    File versionFile
    @OutputFile File buildInfoFile = project.file('src/main/resources/buildinfo.properties')

    @TaskAction
    void readBuildInformation()
    {
        // Jenkins version
        def buildNumber = getPropertyOrDefault("BUILD_NUMBER", null)
        def buildId = getPropertyOrDefault("BUILD_ID", null)
        def buildUrl = getPropertyOrDefault("BUILD_URL", null)
        def buildTag = getPropertyOrDefault("BUILD_TAG", null)
        def gitCommit = getPropertyOrDefault("GIT_COMMIT", null)
        def gitUrl = getPropertyOrDefault("GIT_URL", null)
        def gitBranch = getPropertyOrDefault("GIT_BRANCH", null)

        /* VSO version
        def buildNumber = getPropertyOrDefault("BUILD_BUILDNUMBER", null)
        def buildId = getPropertyOrDefault("BUILD_BUILDID", null)
        def buildUrl = getPropertyOrDefault("BUILD_BUILDURI", null)
        def buildTag = getPropertyOrDefault("BUILD_TAG", null)
        def gitCommit = getPropertyOrDefault("BUILD_SOURCEVERSION", null)
        def gitUrl = getPropertyOrDefault("BUILD_REPOSITORY_URI", null)
        def gitBranch = getPropertyOrDefault("BUILD_SOURCEBRANCH", null)
       */

        def date = new Date()
        def formatter = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ssXXX")

        def buildTime = formatter.format(date)

        def buildVersion = "#.#"

        if (versionFile.exists())
        {
            def versionProps = new Properties()
            versionFile.withInputStream { stream -> versionProps.load(stream) }

            def names = versionProps.stringPropertyNames();

            buildVersion =
                    ((!names.contains('major') || isNullOrEmpty(versionProps.major)) ? "#" : versionProps.major) + "."
            buildVersion += ((!names.contains('minor') || isNullOrEmpty(versionProps.minor)) ? "#" : versionProps.minor)
        }

        def resourcesDirectory = buildInfoFile.parentFile

        resourcesDirectory.mkdirs()

        if (!buildInfoFile.exists())
            buildInfoFile.createNewFile()

        buildInfoFile.withOutputStream {
            stream ->
                def writer = new OutputStreamWriter(stream).newPrintWriter()
                if (isNullOrEmpty(buildNumber))
                    writer.println("build.number: " + buildVersion + ".#")
                else
                    writer.println("build.number: " + buildVersion + "." + buildNumber)
                printIfNotEmpty(writer, "build.timestamp", buildTime)
                printIfNotEmpty(writer, "build.id", buildId)
                printIfNotEmpty(writer, "build.url", buildUrl)
                printIfNotEmpty(writer, "build.tag", buildTag)
                printIfNotEmpty(writer, "git.url", gitUrl)
                printIfNotEmpty(writer, "git.branch", gitBranch)
                printIfNotEmpty(writer, "git.commit", gitCommit)

                writer.close()
                stream.close()

                logger.quiet "Wrote build information to " + buildInfoFile.path
        }
    }

    void printIfNotEmpty(writer, prefix, str)
    {
        if (!isNullOrEmpty(str))
            writer.println(prefix + ": " + str)
    }

    Boolean isNullOrEmpty(str)
    {
        str == null || str.isEmpty()
    }

    String getPropertyOrDefault(name, defaultValue)
    {
        def result = defaultValue;
        def env = System.getenv(name)
        if (!isNullOrEmpty(env))
            result = env;
        result
    }
}



================================================
FILE: src/Backend/OrderService/buildSrc/src/main/groovy/com/microsoft/appinsights/CleanBuildInformationTask.groovy
================================================

package com.microsoft.appinsights

import java.text.SimpleDateFormat
import org.gradle.api.DefaultTask
import org.gradle.api.tasks.*


class CleanBuildInformationTask extends DefaultTask
{
    @TaskAction
    void remove()
    {
        def buildInfoFile = project.file('src/main/resources/buildinfo.properties')

        if (buildInfoFile.exists())
            buildInfoFile.delete()
    }
}



================================================
FILE: src/Backend/OrderService/gradle/wrapper/gradle-wrapper.properties
================================================
#Wed Jan 28 14:56:44 PST 2015
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
distributionUrl=http\://services.gradle.org/distributions/gradle-2.1-bin.zip



================================================
FILE: src/Backend/OrderService/scripts/cat001.json
================================================
{"skuNumber" : "MRP-0001", "description" : "Brake Pads", "price" : 26.99, "inventory" : 10, "leadTime" : 3}



================================================
FILE: src/Backend/OrderService/scripts/cat002.json
================================================
{"skuNumber" : "MRP-0002", "description" : "Brake Calipers", "price" : 33.99, "inventory" : 10, "leadTime" : 3}



================================================
FILE: src/Backend/OrderService/scripts/cat003.json
================================================
{"skuNumber" : "MRP-0003", "description" : "Brake Calipers Guide Pin", "price" : 2.99, "inventory" : 10, "leadTime" : 3}


================================================
FILE: src/Backend/OrderService/scripts/cat004.json
================================================
{"skuNumber" : "MRP-0004", "description" : "Break Calipers Guide Pin Boot Kit", "price" : 8.99, "inventory" : 10, "leadTime" : 5}



================================================
FILE: src/Backend/OrderService/scripts/createorder.sh
================================================
#!/bin/sh
curl -i http://localhost:8080//orders?fromQuote=quote-1 -X POST
echo ""
echo ""

curl -i http://localhost:8080/orders?dealer=BigJoe
echo ""
echo ""







================================================
FILE: src/Backend/OrderService/scripts/dealer1.json
================================================
{"name":"BigJoe","contact":"John Doe","address":"123 Main Street, Redmond, WA 98052","email":"jdoe@tempuri.org", "phone":"425-555-1212"}



================================================
FILE: src/Backend/OrderService/scripts/getenv.sh
================================================
#!/bin/sh
echo ""
echo "Getting the environment"
echo ""

env


================================================
FILE: src/Backend/OrderService/scripts/quote1.json
================================================
{"customerName":"The Little Inn by the Bay",
  "dealerName":"BigJoe",
  "comments":"Here is your quote for our top-of-the-line fridge unit.",
  "terms":"60 days",
  "validUntil":"12/1/14",
  "unitDescription":"CoolnessExtreme",
  "additionalItems":[
    {"skuNumber":"ACC-0001", "shouldPreInstall":false,"amount":100.0},
    {"skuNumber":"ACC-0002", "shouldPreInstall":false,"amount":2.0}
  ],
  "unitCost":12000.0,
  "totalCost":18050.0,
  "discount":1500.0,
  "height":2.5,
  "width":5.0,
  "depth":8.0,
  "unit":"meters",
  "purpose":"Refrigerator",
  "ambientPeak":25.0,
  "ambientAverage":21.0,
  "buildOnSite":true,
  "city":"Wellfleet",
  "postalCode":"02667",
  "state":"MA"}



================================================
FILE: src/Backend/OrderService/scripts/quote2.json
================================================
{"customerName":"The Little Inn by the Bay",
  "dealerName":"BigJoe",
  "comments":"Here is your quote for our top-of-the-line fridge unit.",
  "terms":"60 days",
  "validUntil":"12/1/14",
  "unitDescription":"CoolnessExtreme",
  "additionalItems":[
    {"skuNumber":"ACC-0001", "shouldPreInstall":false,"amount":150.0},
    {"skuNumber":"ACC-0003", "shouldPreInstall":false,"amount":1.0},
    {"skuNumber":"ACC-0004", "shouldPreInstall":false,"amount":50.0}
  ],
  "unitCost":12000.0,
  "totalCost":18050.0,
  "discount":1500.0,
  "height":2.5,
  "width":5.0,
  "depth":8.0,
  "unit":"meters",
  "purpose":"Refrigerator",
  "ambientPeak":25.0,
  "ambientAverage":21.0,
  "buildOnSite":true,
  "city":"Wellfleet",
  "postalCode":"02667",
  "state":"MA"}



================================================
FILE: src/Backend/OrderService/scripts/schema.psql
================================================
DROP DATABASE Fabrikant;

DROP TABLE ShipmentEventInfo;
DROP TABLE ShipmentRecords;
DROP TABLE DeliveryAddress;
DROP TABLE PhoneInfo;

DROP TABLE OrderEvents;
DROP TABLE Orders;
DROP TABLE QuoteAdditionalItemRecord;
DROP TABLE Quotes;
DROP TABLE CatalogItem;
DROP TABLE Dealers;

CREATE DATABASE Fabrikant;

CREATE TABLE CatalogItems
(
  sku_number VARCHAR(32) PRIMARY KEY,
  description VARCHAR(128),
  price  NUMERIC(8,2)
);

CREATE TABLE Dealers
(
  name VARCHAR(50) PRIMARY KEY,
  contact VARCHAR(50) NOT NULL,
  address VARCHAR(128) NOT NULL,
  email VARCHAR(128) NOT NULL,
  phone VARCHAR(16) NOT NULL
);

CREATE TABLE Quotes
(
  quote_id varchar(64) primary key,

  valid_until varchar(32),

  customer_name varchar(64),
  dealer_name varchar(50),

  total_cost  NUMERIC(8,2),
  discount  NUMERIC(8,2),

  city varchar(32),
  postal_code varchar(16),
  state char(2),

  foreign key (dealer_name) references Dealers(name)
);

CREATE TABLE QuoteAdditionalItemRecord
(
  id serial PRIMARY KEY,

  quote_id varchar(64),
  sku_number VARCHAR(32),

  amount numeric(5,2),

  foreign key (quote_id) references Quotes,
  foreign key (sku_number) references CatalogItems
);

create table Orders
(
  order_id varchar(80) primary key,
  quote_id varchar(64),
  order_date varchar(32),
  status varchar(16),

  foreign key (quote_id) references Quotes(quote_id)
);

create table OrderEvents
(
  id serial primary key,

  order_id varchar(80),
  order_date varchar(32),
  comments varchar(128),

  foreign key (order_id) references Orders(order_id)
);

create table PhoneInfo
(
  phone VARCHAR(16) PRIMARY KEY,
  kind varchar(16)
);

create table DeliveryAddress
(
  id serial primary key,
  street varchar(128),
  city varchar(32),
  state char(2),
  postal_code varchar(16)
);

create table ShipmentRecords
(
  order_id varchar(80) primary key,

  delivery_date varchar(32),
  delivery_address integer,
  contact_name varchar(64),
  primary_phone varchar(16),
  alternate_phone varchar(16),

  foreign key (order_id) references Orders(order_id),
  foreign key (delivery_address) references DeliveryAddress(id),
  foreign key (primary_phone) references PhoneInfo(phone),
  foreign key (alternate_phone) references PhoneInfo(phone)
);

create table ShipmentEventInfo
(
  id serial primary key,
  order_id varchar(80),
  date varchar(32),
  comments varchar(128),

  foreign key (order_id) references Orders(order_id)
);



================================================
FILE: src/Backend/OrderService/scripts/setup.sh
================================================
#!/bin/sh
curl -i http://localhost:8080/dealers -X POST -H "Content-Type: application/json" -d @dealer1.json
echo ""
echo ""
curl -i http://localhost:8080/catalog -X POST -H "Content-Type: application/json" -d @cat001.json
echo ""
echo ""
curl -i http://localhost:8080/catalog -X POST -H "Content-Type: application/json" -d @cat002.json
echo ""
echo ""
curl -i http://localhost:8080/catalog -X POST -H "Content-Type: application/json" -d @cat003.json
echo ""
echo ""
curl -i http://localhost:8080/catalog -X POST -H "Content-Type: application/json" -d @cat004.json
echo ""
echo ""

curl -i http://localhost:8080/dealers
echo ""
echo ""
curl -i http://localhost:8080/catalog
echo ""
echo ""

curl -i http://localhost:8080/quotes -X POST -H "Content-Type: application/json" -d @quote1.json
echo ""
echo ""




================================================
FILE: src/Backend/OrderService/scripts/setupdocker.sh
================================================
#!/bin/sh
curl -i http://192.168.59.103:8080/ordering-0.1.0/dealers -X POST -H "Content-Type: application/json" -d @dealer1.json
echo ""
echo ""
curl -i http://192.168.59.103:8080/ordering-0.1.0/catalog -X POST -H "Content-Type: application/json" -d @cat001.json
echo ""
echo ""
curl -i http://192.168.59.103:8080/ordering-0.1.0/catalog -X POST -H "Content-Type: application/json" -d @cat002.json
echo ""
echo ""
curl -i http://192.168.59.103:8080/ordering-0.1.0/catalog -X POST -H "Content-Type: application/json" -d @cat003.json
echo ""
echo ""
curl -i http://192.168.59.103:8080/ordering-0.1.0/catalog -X POST -H "Content-Type: application/json" -d @cat004.json
echo ""
echo ""

curl -i http://192.168.59.103:8080/ordering-0.1.0/dealers
echo ""
echo ""
curl -i http://192.168.59.103:8080/ordering-0.1.0/catalog
echo ""
echo ""

curl -i http://192.168.59.103:8080/ordering-0.1.0/quotes -X POST -H "Content-Type: application/json" -d @quote1.json
echo ""
echo ""




================================================
FILE: src/Backend/OrderService/scripts/update.sh
================================================
#!/bin/sh
curl -i http://localhost:8080/quotes/quote-1 -X PUT -H "Content-Type: application/json" -d @quote2.json
echo ""
echo ""






================================================
FILE: src/Backend/OrderService/src/main/java/smpl/ordering/AppInsightsFilter.java
================================================
package smpl.ordering;

import javax.servlet.*;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.Date;

import com.microsoft.applicationinsights.TelemetryClient;
import com.microsoft.applicationinsights.telemetry.ExceptionHandledAt;
import com.microsoft.applicationinsights.telemetry.ExceptionTelemetry;
import com.microsoft.applicationinsights.telemetry.Duration;
import com.microsoft.applicationinsights.telemetry.RequestTelemetry;
import com.microsoft.applicationinsights.telemetry.TelemetryContext;

import org.springframework.stereotype.Component;

@Component
public class AppInsightsFilter implements Filter
{
    @Override
    public void init(FilterConfig filterConfig) throws ServletException
    {
    }

    @Override
    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException
    {
        TelemetryClient client = Utility.getTelemetryClient();

        if (client != null && client.getContext() != null && !Utility.isNullOrEmpty(client.getContext().getInstrumentationKey())) // && !client.isDisabled())
        {
            Date startTime = new Date();

            HttpServletRequest request = (HttpServletRequest) req;
            String method = request.getMethod();
            String rURI = request.getRequestURI();
            String scheme = request.getScheme();
            String host = request.getHeader("Host");
            String query = request.getQueryString();
            String session = request.getSession().getId();
            String name = request.getServletPath();

            RequestTelemetry telemetry = new RequestTelemetry(String.format("%s %s", method, rURI), startTime, 0L, "200", false);
            telemetry.setHttpMethod(method);
            telemetry.setTimestamp(startTime); // Doesn't work right now.
            telemetry.setName(name);

            if (!Utility.isNullOrEmpty(query))
            {
                telemetry.setUrl(String.format("%s://%s%s?%s", scheme, host, rURI, query));
            }
            else
            {
                telemetry.setUrl(String.format("%s://%s%s", scheme, host, rURI));
            }

            TelemetryContext ctx = client.getContext();

            if (!Utility.isNullOrEmpty(session))
            {
                ctx.getSession().setId(session);
            }

            ctx.getOperation().setId(telemetry.getId());
            ctx.getOperation().setName(telemetry.getName());

            try
            {
                chain.doFilter(req, res);

                Date endTime = new Date();

                HttpServletResponse response = (HttpServletResponse) res;

				Duration duration = new Duration(endTime.getTime() - startTime.getTime());
                telemetry.setDuration(duration);
                telemetry.setResponseCode(((Integer) response.getStatus()).toString());

                client.track(telemetry);

                // Clear the operation id.
                ctx.getOperation().setId(null);
                ctx.getOperation().setName(null);
            }
            catch (Exception exc)
            {
                Date endTime = new Date();

                ExceptionTelemetry ext = new ExceptionTelemetry(exc);
                ext.setExceptionHandledAt(ExceptionHandledAt.Platform);
                client.track(ext);

				Duration duration = new Duration(endTime.getTime() - startTime.getTime());
                telemetry.setDuration(duration);
                telemetry.setResponseCode("500");
                telemetry.setSuccess(false);

                client.track(telemetry);

                // Clear the operation id.
                ctx.getOperation().setId(null);
                ctx.getOperation().setName(null);
                
                throw exc;
            }
        }
        else
        {
            chain.doFilter(req, res);
        }
    }

    @Override
    public void destroy()
    {

    }
}



================================================
FILE: src/Backend/OrderService/src/main/java/smpl/ordering/BadRequestException.java
================================================
package smpl.ordering;

/**
 * Communicating a bad REST request from a called API to the controller, which should use
 * it to create a BAD_REQUEST HTTP response.
 */
public class BadRequestException
        extends Exception
{
    public BadRequestException(String message)
    {
        super(message);
    }
}



================================================
FILE: src/Backend/OrderService/src/main/java/smpl/ordering/ConflictingRequestException.java
================================================
package smpl.ordering;

/**
 * Communicating a conflicting REST request from a called API to the controller, which should use
 * it to create a CONFLICT HTTP response.
 */
public class ConflictingRequestException
        extends BadRequestException
{
    public ConflictingRequestException(String message)
    {
        super(message);
    }
}



================================================
FILE: src/Backend/OrderService/src/main/java/smpl/ordering/MongoDBProperties.java
================================================
package smpl.ordering;

import org.springframework.boot.context.properties.ConfigurationProperties;

/**
 * Holds configuration properties pertaining to the MongoDB connection.
 */
@ConfigurationProperties(prefix = "mongodb")
public class MongoDBProperties
{
    private String host = "localhost";
    private String database = "ordering";

    public String getHost()
    {
        return host;
    }

    public void setHost(String host)
    {
        this.host = host;
    }

    public String getDatabase()
    {
        return database;
    }

    public void setDatabase(String database)
    {
        this.database = database;
    }
}



================================================
FILE: src/Backend/OrderService/src/main/java/smpl/ordering/OrderingConfiguration.java
================================================
package smpl.ordering;

import com.microsoft.applicationinsights.TelemetryClient;
import com.microsoft.applicationinsights.TelemetryConfiguration;
import com.mongodb.MongoClient;
import com.mongodb.MongoClientOptions;
import com.mongodb.ServerAddress;
import org.springframework.beans.BeansException;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.EnableAutoConfiguration;
import org.springframework.boot.autoconfigure.condition.ConditionalOnClass;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.ApplicationContext;
import org.springframework.context.ApplicationContextAware;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.mongodb.core.MongoTemplate;
import smpl.ordering.repositories.RepositoryFactory;

import java.net.URL;
import java.util.ArrayList;
import java.util.List;

@SuppressWarnings("ALL")
@Configuration
@ComponentScan
@EnableAutoConfiguration
@ConditionalOnClass({MongoDBProperties.class, OrderingServiceProperties.class})
@EnableConfigurationProperties({MongoDBProperties.class, OrderingServiceProperties.class})
public class OrderingConfiguration
        implements ApplicationContextAware
{
    public static void main(String[] args)
    {
        SpringApplication app = new SpringApplication(OrderingConfiguration.class);
        app.setLogStartupInfo(false);
        app.run(args);
    }

    public OrderingConfiguration()
    {
        t_ambientTelemetryClient = new ThreadLocal<>();
    }

    public
    @Bean
    MongoTemplate mongoTemplate() throws Exception
    {
        MongoClient client;
        MongoClientOptions.Builder options = MongoClientOptions.builder();
        options.socketKeepAlive(false);

        String mongoHost = mongoDBProperties.getHost();
        String mongoPort = System.getenv("MONGO_PORT"); // Anticipating use within a docker container.

        if (!Utility.isNullOrEmpty(mongoPort))
        {
            URL portUrl = new URL(mongoPort.replace("tcp:", "http:"));
            mongoHost = portUrl.getHost();
        }

        String mongoDB = mongoDBProperties.getDatabase();

        if (mongoDB != null && !mongoDB.isEmpty() && mongoHost != null && !mongoHost.isEmpty())
        {
            List<ServerAddress> hosts = new ArrayList<>();
            for (String host : mongoHost.split(","))
            {
                hosts.add(new ServerAddress(host));
            }
            client = new MongoClient(hosts, options.build());

        }
        else
        {
            client = new MongoClient();
        }

        return new MongoTemplate(client, mongoDB);
    }

    public
    @Bean
    RepositoryFactory repositoryFactory()
    {
        RepositoryFactory.reset(orderingServiceProperties.getStorage());
        return RepositoryFactory.getFactory();
    }

    public
    @Bean
    OrderingServiceProperties orderingServiceProperties()
    {
        return orderingServiceProperties;
    }

    public
    @Bean
    TelemetryClient getTelemetryClient()
    {
        if (TelemetryConfiguration.getActive() == null)
        {
            return null;
        }

        //TelemetryConfiguration.getActive().getChannel().setDeveloperMode(true);

        TelemetryClient client = t_ambientTelemetryClient.get();
        if (client == null)
        {
            TelemetryConfiguration config = TelemetryConfiguration.getActive();
            String iKey = orderingServiceProperties.getInstrumentationKey();

            if (!Utility.isNullOrEmpty(iKey))
                config.setInstrumentationKey(iKey);

            t_ambientTelemetryClient.set(new TelemetryClient(config));
        }

        return t_ambientTelemetryClient.get();
    }

    @Autowired
    private OrderingServiceProperties orderingServiceProperties;

    @SuppressWarnings("SpringJavaAutowiringInspection")
    @Autowired
    private MongoDBProperties mongoDBProperties;

    private static ApplicationContext applicationContext;

    private static ThreadLocal<TelemetryClient> t_ambientTelemetryClient;

    @Override
    public void setApplicationContext(ApplicationContext context) throws BeansException
    {
        applicationContext = context;
    }

    public static ApplicationContext getApplicationContext()
    {
        return applicationContext;
    }

}



================================================
FILE: src/Backend/OrderService/src/main/java/smpl/ordering/OrderingInitializer.java
================================================
package smpl.ordering;

import org.springframework.boot.builder.SpringApplicationBuilder;
import org.springframework.boot.context.web.SpringBootServletInitializer;

import javax.servlet.ServletContext;
import javax.servlet.ServletException;

/**
 * This is the application starting point when the application is deployed in Tomcat on a server.
 */
public class OrderingInitializer
        extends SpringBootServletInitializer
{
    @Override
    protected SpringApplicationBuilder configure(SpringApplicationBuilder application)
    {
        return application.sources(OrderingConfiguration.class);
    }

    @Override
    public void onStartup(ServletContext servletContext) throws ServletException
    {
        super.onStartup(servletContext);

        if (servletContext != null)
        {
            String path = servletContext.getContextPath();
            if (path != null)
            {
                s_applicationPath = path;
            }
        }
    }

    public static String getApplicationPath()
    {
        return s_applicationPath;
    }

    private static String s_applicationPath = "";
}



================================================
FILE: src/Backend/OrderService/src/main/java/smpl/ordering/OrderingServiceProperties.java
================================================
package smpl.ordering;

import org.springframework.boot.context.properties.ConfigurationProperties;

/**
 * Holds general service configuration properties.
 */
@ConfigurationProperties(prefix = "ordering")
public class OrderingServiceProperties
{
    private String storage = "memory";
    private String pingMessage = "The ordering service is available";
    private String validationMessage = "Version unknown";
    private String instrumentationKey = "";

    public String getStorage()
    {
        return storage;
    }

    public void setStorage(String storage)
    {
        this.storage = storage;
    }

    public String getValidationMessage()
    {
        return validationMessage;
    }

    public void setValidationMessage(String validationMessage)
    {
        this.validationMessage = validationMessage;
    }

    public String getPingMessage()
    {
        return pingMessage;
    }

    public void setPingMessage(String message)
    {
        this.pingMessage = message;
    }

    public String getInstrumentationKey()
    {
        return instrumentationKey;
    }

    public void setInstrumentationKey(String instrumentationKey)
    {
        this.instrumentationKey = instrumentationKey;
    }

}



================================================
FILE: src/Backend/OrderService/src/main/java/smpl/ordering/PostgresqlProperties.java
================================================
package smpl.ordering;

import org.springframework.boot.context.properties.ConfigurationProperties;

/**
 * Holds configuration properties pertaining to the PostgreSQL connection.
 */
@ConfigurationProperties(prefix = "postgresql")
public class PostgresqlProperties
{
    private String username;
    private String password;
    private String driverClass;
    private String url;

    public String getUsername()
    {
        return username;
    }

    public void setUsername(String username)
    {
        this.username = username;
    }

    public String getPassword()
    {
        return password;
    }

    public void setPassword(String password)
    {
        this.password = password;
    }

    public String getDriverClass()
    {
        return driverClass;
    }

    public void setDriverClass(String driverClass)
    {
        this.driverClass = driverClass;
    }

    public String getUrl()
    {
        return url;
    }

    public void setUrl(String url)
    {
        this.url = url;
    }
}



================================================
FILE: src/Backend/OrderService/src/main/java/smpl/ordering/PropertyHelper.java
================================================
package smpl.ordering;

import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.util.Properties;

/**
 * Helper class for getting data out of the 'application.properties' file found on the
 * class path.
 */
public class PropertyHelper
{
    public static Properties getPropValues(String propFileName) throws IOException
    {

        Properties props = new Properties();

        InputStream inputStream = PropertyHelper.class.getClassLoader().getResourceAsStream(propFileName);
        props.load(inputStream);
        if (inputStream == null)
        {
            throw new FileNotFoundException("property file '" + propFileName + "' not found in the classpath");
        }

        return props;
    }

    public static Properties getProperties()
    {
        return s_props;
    }

    static
    {
        try
        {
            s_props = getPropValues("application.properties");
        }
        catch (IOException e)
        {
            s_props = new Properties();
        }
    }


    private static Properties s_props;
}



================================================
FILE: src/Backend/OrderService/src/main/java/smpl/ordering/SimpleCORSFilter.java
================================================
package smpl.ordering;

import java.io.IOException;
import java.util.Enumeration;
import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.springframework.stereotype.Component;

@Component
public class SimpleCORSFilter implements Filter
{

    public void doFilter(ServletRequest req, ServletResponse res, FilterChain chain) throws IOException, ServletException
    {
        HttpServletResponse response = (HttpServletResponse) res;
        response.setHeader("Access-Control-Allow-Origin", "*");
        response.setHeader("Access-Control-Allow-Methods", "PUT, POST, GET, OPTIONS, DELETE");
        response.setHeader("Access-Control-Max-Age", "1");
        response.setHeader("Access-Control-Allow-Headers", "Origin, X-Requested-With, Content-Type, Accept, Pragma, Cache-Control, If-Modified-Since");

        chain.doFilter(req, res);
    }

    public void init(FilterConfig filterConfig)
    {
    }

    public void destroy()
    {
    }
}



================================================
FILE: src/Backend/OrderService/src/main/java/smpl/ordering/TestPath.java
================================================
package smpl.ordering;

/**
 * Interface for unit test hooks into various backend components.
 */
public interface TestPath
{
    public void reset();
}



================================================
FILE: src/Backend/OrderService/src/main/java/smpl/ordering/Utility.java
================================================
package smpl.ordering;

import com.microsoft.applicationinsights.TelemetryClient;
import org.springframework.context.ApplicationContext;

public class Utility
{
    public static int validateStringField(String field, String fieldName, int count, StringBuilder errors)
    {
        if (isNullOrEmpty(field))
        {
            if (count == 0)
            {
                errors.append(String.format("\"Empty %s field\"", fieldName));
            }
            else
            {
                errors.append(String.format(",\"Empty %s field\"", fieldName));
            }
            count += 1;
        }
        return count;
    }

    public static boolean isNullOrEmpty(String str)
    {
        return str == null || str.isEmpty();
    }

    public static TelemetryClient getTelemetryClient()
    {
        ApplicationContext ctx = OrderingConfiguration.getApplicationContext();
        if (ctx == null) return null;
        return ctx.getBean(TelemetryClient.class);
    }
}



================================================
FILE: src/Backend/OrderService/src/main/java/smpl/ordering/controllers/CatalogController.java
================================================
package smpl.ordering.controllers;

import com.microsoft.applicationinsights.TelemetryClient;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import smpl.ordering.OrderingInitializer;
import smpl.ordering.Utility;
import smpl.ordering.models.CatalogItem;
import smpl.ordering.repositories.CatalogItemsRepository;
import smpl.ordering.repositories.RepositoryFactory;

import java.util.List;

@Controller
@RequestMapping("/catalog")
public class CatalogController
{
    /**
     * Gets a list of available catalog item.
     *
     * @return An HttpResponse containing a list of catalog item.
     */
    @RequestMapping(method = RequestMethod.GET)
    public ResponseEntity getCatalogItems()
    {
        try
        {
            List<CatalogItem> catalog = getRepository().getCatalogItems();
            if (catalog == null || catalog.size() == 0)
            {
                return new ResponseEntity(HttpStatus.NOT_FOUND);
            }
            else
            {
                return new ResponseEntity<>(catalog, HttpStatus.OK);
            }
        }
        catch (Exception exc)
        {
            exc.printStackTrace();
            // Don't cache the client -- it's relying on thread-local storage.
            TelemetryClient client = Utility.getTelemetryClient();
            if (client != null) client.trackException(exc);
            return new ResponseEntity<>(exc.toString(), HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }


    /**
     * Gets a specific catalog item by its id.
     *
     * @param sku The SKU number
     * @return An HttpResponse containing an catalog item record.
     */
    @RequestMapping(method = RequestMethod.GET, value = "/{sku}")
    public ResponseEntity getCatalogItem(@PathVariable String sku)
    {
        try
        {
            CatalogItem catalogItem = getRepository().getCatalogItem(sku);
            if (catalogItem == null)
            {
                return new ResponseEntity(HttpStatus.NOT_FOUND);
            }
            else
            {
                return new ResponseEntity<>(catalogItem, HttpStatus.OK);
            }
        }
        catch (Exception exc)
        {
            // Don't cache the client -- it's relying on thread-local storage.
            TelemetryClient client = Utility.getTelemetryClient();
            if (client != null) client.trackException(exc);
            return new ResponseEntity<>(exc.getMessage(), HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }

    /**
     * Adds or updates an catalog item SKU
     *
     * @param info Information about the SKU
     * @return An HTTP status code.
     */
    @RequestMapping(method = RequestMethod.POST)
    public ResponseEntity addCatalogItem(@RequestBody CatalogItem info)
    {
        String errorMsg = info.validate();
        if (errorMsg != null)
        {
            return new ResponseEntity<>(errorMsg, HttpStatus.BAD_REQUEST);
        }

        try
        {
            CatalogItem catalogItem = getRepository().getCatalogItem(info.getSkuNumber());
            if (catalogItem != null)
            {
                return new ResponseEntity<>("The SKU already exists", HttpStatus.CONFLICT);
            }

            boolean result = getRepository().upsertCatalogItem(info.getSkuNumber(), info, null);
            String applicationPath = OrderingInitializer.getApplicationPath();
            HttpHeaders responseHeaders = new HttpHeaders();
            responseHeaders.set("Location", applicationPath + "/catalog/" + info.getSkuNumber());
            return new ResponseEntity(responseHeaders, result ? HttpStatus.OK : HttpStatus.CREATED);
        }
        catch (Exception exc)
        {
            // Don't cache the client -- it's relying on thread-local storage.
            TelemetryClient client = Utility.getTelemetryClient();
            if (client != null) client.trackException(exc);
            return new ResponseEntity<>(exc.getMessage(), HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }

    /**
     * Adds or updates an CatalogItem SKU
     *
     * @param sku  The SKU number
     * @param info Information about the SKU
     * @return An HTTP status code.
     */
    @RequestMapping(method = RequestMethod.PUT, value = "/{sku}")
    public ResponseEntity upsertCatalogItem(@PathVariable String sku, @RequestBody CatalogItem info)
    {
        String errorMsg = info.validate();
        if (errorMsg != null)
        {
            return new ResponseEntity<>(errorMsg, HttpStatus.BAD_REQUEST);
        }

        try
        {
            CatalogItem catalogItem = getRepository().getCatalogItem(sku);
            if (catalogItem == null)
            {
                return new ResponseEntity<CatalogItem>(HttpStatus.NOT_FOUND);
            }
            boolean result = getRepository().upsertCatalogItem(sku, info, null);
            return new ResponseEntity(result ? HttpStatus.OK : HttpStatus.CREATED);
        }
        catch (Exception exc)
        {
            // Don't cache the client -- it's relying on thread-local storage.
            TelemetryClient client = Utility.getTelemetryClient();
            if (client != null) client.trackException(exc);
            return new ResponseEntity<>(exc.getMessage(), HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }

    /**
     * Remove an catalog item SKU from the catalog.
     *
     * @param sku The SKU number.
     * @return An HTTP status code.
     */
    @RequestMapping(method = RequestMethod.DELETE, value = "/{sku}")
    public ResponseEntity removeCatalogItem(@PathVariable String sku)
    {

        try
        {
            if (getRepository().removeCatalogItem(sku, null))
            {
                return new ResponseEntity<CatalogItem>(HttpStatus.NO_CONTENT);
            }
            else
            {
                return new ResponseEntity<CatalogItem>(HttpStatus.NOT_FOUND);
            }
        }
        catch (Exception exc)
        {
            // Don't cache the client -- it's relying on thread-local storage.
            TelemetryClient client = Utility.getTelemetryClient();
            if (client != null) client.trackException(exc);
            return new ResponseEntity<>(exc.getMessage(), HttpStatus.INTERNAL_SERVER_ERROR);
        }
    }

    private CatalogItemsRepository getRepository()
    {
        return RepositoryFactory.getCatalogItemsRepository();
    }
}